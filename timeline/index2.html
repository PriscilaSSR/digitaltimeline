<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Technology Timeline</title>
    <style>
        /* Basic Reset & Font */
        html, body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f0f4f8;
            touch-action: none;
        }

        /* Main Title Styling (Floating) */
        #main-title {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            z-index: 90;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #343a40;
            cursor: grab;
            border: 1px solid #dee2e6;
        }

        /* Main container */
        .main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #ffffff;
             border-radius: 0px;
             box-shadow: none;
        }

        /* Chart container */
        #chart-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            position: relative;
            overflow: hidden;
        }

        /* SVG Styling */
        #chart-container svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Sidebar Styling */
        .sidebar {
            position: absolute;
            top: 0;
            left: -350px;
            height: 100%;
            width: 350px;
            max-width: 90%;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: left 0.3s ease-in-out;
            z-index: 100;
            border-left: 1px solid #dee2e6;
        }
        .sidebar.active { left: 0; }
        .sidebar-content { padding: 25px; position: relative; }
        .sidebar-close {
            position: absolute; top: 15px; right: 15px; width: 32px; height: 32px;
            background-color: #e9ecef; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.2s, transform 0.2s; font-weight: bold;
            border: none; font-size: 18px; color: #495057;
        }
        .sidebar-close:hover { background-color: #ced4da; transform: rotate(90deg); }
        .sidebar-image {
            width: 100%; height: auto; max-height: 200px; object-fit: cover;
            margin-bottom: 15px; border-radius: 6px; border: 1px solid #dee2e6;
        }
        /* Sidebar Title/Subtitle now often come from Overview */
        .sidebar-title { font-size: 1.6rem; margin-bottom: 5px; padding-right: 40px; color: #212529; font-weight: 600; }
        .sidebar-subtitle { font-size: 1.1rem; margin-bottom: 15px; color: #495057; font-weight: 500; }
        .sidebar-text { line-height: 1.7; margin-bottom: 20px; color: #343a40; font-size: 0.95rem; }

        /* Chart Segment Styling */
        .segment {
            cursor: pointer; /* Clickable again */
            transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out;
            stroke: rgba(0,0,0,0.1);
            stroke-width: 0.5px;
        }
        .segment:hover {
            opacity: 0.85;
            filter: brightness(1.05);
        }

        /* Interactive Dot Styling */
        .interactive-dot {
            cursor: pointer;
            stroke: rgba(0, 0, 0, 0.4);
            stroke-width: 1px;
            transition: r 0.2s ease-in-out, filter 0.2s ease-in-out, opacity 0.2s ease-in-out;
            fill-opacity: 0.85;
        }
        .interactive-dot:hover {
            r: 7;
            stroke-width: 1.5px;
            filter: brightness(1.2);
            fill-opacity: 1;
        }

        /* Tooltip Styling */
        .tooltip {
            position: absolute; padding: 8px 12px; background: rgba(0, 0, 0, 0.8);
            color: white; border-radius: 4px; pointer-events: none; opacity: 0;
            transition: opacity 0.2s ease-in-out; font-size: 0.85rem; z-index: 110;
            white-space: nowrap;
        }

        /* Legend Styling */
        .legend {
            position: absolute; display: flex; flex-direction: column; gap: 0px;
            background-color: rgba(255, 255, 255, 0.95); border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); padding: 0; max-width: 280px;
            max-height: 70vh; z-index: 90; right: 20px; bottom: 20px;
            transition: opacity 0.3s ease, box-shadow 0.3s ease; border: 1px solid #dee2e6;
        }
        .legend-drag-handle {
            cursor: move; width: 100%; height: 18px; display: flex; justify-content: center;
            align-items: center; background-color: #f1f3f5; border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0; box-sizing: border-box;
        }
        .legend-drag-handle:before { content: ""; width: 40px; height: 5px; background-color: #adb5bd; border-radius: 3px; }
        .legend-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 12px; box-sizing: border-box; border-bottom: 1px solid #e9ecef; }
        .legend-title { font-weight: 600; font-size: 1rem; margin: 0; color: #343a40; }
        .legend-toggle { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #495057; padding: 0 5px; line-height: 1; transition: color 0.2s, transform 0.2s; }
        .legend-toggle:hover { color: #212529; transform: scale(1.1); }
        .legend-content { display: flex; flex-direction: column; gap: 8px; width: 100%; padding: 12px; box-sizing: border-box; max-height: calc(70vh - 80px); overflow-y: auto; transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out; }
        .legend-category { margin-top: 5px; margin-bottom: 3px; font-weight: 600; font-size: 0.9rem; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 3px; }
        .legend-category:first-child { margin-top: 0; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #495057; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); }
        .legend-content.legend-minimized { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; border-top: none; }

        /* Sidebar Tab Styling (Re-enabled) */
        .content-tabs {
            display: flex;
            flex-wrap: wrap;
            margin-top: 15px; /* Space above tabs */
            margin-bottom: 20px;
            gap: 8px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .tab-button {
            padding: 8px 15px;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        .tab-button:hover:not(.active) {
            background-color: #ced4da;
            border-color: #adb5bd;
        }
        .content-section {
            display: none; /* Hide inactive content */
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }


        /* Arrow Styling */
        .arrow { filter: drop-shadow(0px 1px 1.5px rgba(0,0,0,0.2)); transition: transform 0.2s ease-in-out; }
        .connector {} /* Connector class no longer used */

        /* Zoom Controls Styling */
        .zoom-controls { position: absolute; right: 20px; top: 20px; z-index: 50; display: flex; flex-direction: column; gap: 8px; }
        .zoom-button { width: 40px; height: 40px; font-size: 20px; font-weight: bold; border-radius: 50%; border: 1px solid #ced4da; background-color: white; color: #495057; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s; }
        .zoom-button:hover { background-color: #f1f3f5; border-color: #adb5bd; }
        .zoom-button:active { box-shadow: 0 1px 2px rgba(0,0,0,0.1); transform: scale(0.95); }

        /* Zoom Indicator Styling */
        #zoom-indicator { position: absolute; left: 20px; bottom: 20px; padding: 6px 12px; background-color: rgba(0,0,0,0.7); color: white; border-radius: 4px; font-size: 0.9rem; transition: opacity 0.3s ease-in-out; opacity: 0; z-index: 50; pointer-events: none; }

        /* Label Styling */
        .label-group text { pointer-events: none; font-weight: bold; font-size: 12px; fill: #fff; }
        .label-group .label-shadow { stroke: rgba(0,0,0,0.6); stroke-width: 3px; stroke-linejoin: round; fill: none; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <h1 id="main-title">Interactive Aviation Timeline</h1>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content" id="sidebar-content">
                </div>
        </div>

        <div id="chart-container">
             </div>

        <div class="zoom-controls" id="zoom-controls">
            </div>

        <div id="zoom-indicator">Zoom: 100%</div>
    </div>

    <div class="legend" id="legend">
         </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // --- Configuration ---
        let config = {};
        let scaleFactor = 1;
        let gapSize = 15;

        // --- State Variables ---
        let currentZoom = 1;
        let panOffsetX = 0;
        let panOffsetY = 0;
        let isPanning = false;
        let lastPointerX = 0;
        let lastPointerY = 0;
        let initialPinchDistance = 0;

        // --- DOM Elements ---
        let chartContainer, svgElement, chartGroup, sidebar, sidebarContent, tooltip, legendContainer, zoomIndicator, mainTitleElement;

        // --- Placeholder Image Handling ---
        const placeholderBase = "https://placehold.co";
        function getPlaceholderUrl(width = 400, height = 250, text = "Image") {
            return `${placeholderBase}/${width}x${height}/EBF0F5/777?text=${encodeURIComponent(text)}`;
        }
        function handleImageError(imgElement) {
            console.warn(`Image failed to load: ${imgElement.src}. Using placeholder.`);
            imgElement.src = getPlaceholderUrl(300, 180, 'Not Found');
            imgElement.onerror = null;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            chartContainer = document.getElementById('chart-container');
            sidebar = document.getElementById('sidebar');
            sidebarContent = document.getElementById('sidebar-content');
            tooltip = document.getElementById('tooltip');
            legendContainer = document.getElementById('legend');
            zoomIndicator = document.getElementById('zoom-indicator');
            mainTitleElement = document.getElementById('main-title');

            initializeConfig();
            createChart();
            addZoomControls();
            setupEventListeners();
            applyTransform();

            if (mainTitleElement) {
                makeDraggable(mainTitleElement);
            }
        });

        // --- Configuration Setup (Added segmentOverviews) ---
        function initializeConfig() {
            const dimensions = getResponsiveDimensions();
            config = {
                ...dimensions,
                rings: [
                     {
                        name: "Dream of Flight", radius: 200, color: "#8A2BE2", segments: 3,
                        segmentNames: ["Ancient Times", "Renaissance", "Early Experiments"],
                        segmentOverviews: [
                            { title: "Dream of Flight", subtitle: "Ancient Times (Overview)", text: "Humanity's earliest dreams of flight, expressed through myths like Icarus and early inventions like kites.", imageSrc: getPlaceholderUrl(400,250,'Ancient Overview') },
                            { title: "Dream of Flight", subtitle: "Renaissance (Overview)", text: "A period of renewed interest in observation and mechanics, with figures like Leonardo da Vinci sketching conceptual flying machines.", imageSrc: getPlaceholderUrl(400,250,'Renaissance Overview') },
                            { title: "Dream of Flight", subtitle: "Early Experiments (Overview)", text: "The first scientific approaches to flight, including ballooning and foundational work on aerodynamics by pioneers like Cayley.", imageSrc: getPlaceholderUrl(400,250,'Experiments Overview') }
                        ],
                        segmentDetails: [
                            [
                                { title: "Icarus & Daedalus", subtitle: "c. 500s BCE (Myth)", text: "The Greek myth of Icarus and Daedalus flying with wax and feather wings embodies humanity's earliest recorded aspirations and cautionary tales about flight.", imageSrc: getPlaceholderUrl(400, 250, 'Icarus Myth') },
                                { title: "Kites in China", subtitle: "c. 400s BCE", text: "Early kites in China demonstrated an understanding of aerodynamic principles and were used for signaling, measuring distances, and even testing wind.", imageSrc: getPlaceholderUrl(400, 250, 'Ancient Kite') }
                            ],
                            [
                                { title: "Leonardo da Vinci", subtitle: "c. 1500 CE", text: "Da Vinci's detailed sketches of flying machines (ornithopters, helicopters, gliders) based on bird flight marked a shift towards scientific observation, though none were built.", imageSrc: getPlaceholderUrl(400, 250, 'Da Vinci Sketch') },
                                { title: "Newton's Laws", subtitle: "1687 CE", text: "Isaac Newton's laws of motion and universal gravitation provided the fundamental physics principles necessary for understanding lift and flight dynamics.", imageSrc: getPlaceholderUrl(400, 250, 'Newton Laws') }
                            ],
                            [
                                { title: "Montgolfier Brothers", subtitle: "1783 CE", text: "The Montgolfier brothers achieved the first untethered human flight in a hot air balloon, demonstrating lighter-than-air flight.", imageSrc: getPlaceholderUrl(400, 250, 'Montgolfier Balloon') },
                                { title: "Sir George Cayley", subtitle: "Early 1800s CE", text: "Often called the 'Father of Aviation', Cayley identified the four forces of flight (lift, drag, thrust, weight) and designed early gliders, separating lift and propulsion.", imageSrc: getPlaceholderUrl(400, 250, 'Cayley Glider') }
                            ]
                        ]
                    },
                    { name: "Connector 1", color: "#7D59D9", isConnector: true, arrowCount: 8, thickness: 7 },
                    {
                        name: "Powered Flight Era", radius: 150, color: "#4169E1", segments: 4,
                        segmentNames: ["Pioneers", "WWI", "Golden Age", "WWII"],
                        segmentOverviews: [
                            { title: "Powered Flight Era", subtitle: "Pioneers (Overview)", text: "The dawn of controlled, powered flight with the Wright Brothers and early record-setters crossing geographical barriers.", imageSrc: getPlaceholderUrl(400,250,'Pioneers Overview') },
                            { title: "Powered Flight Era", subtitle: "WWI (Overview)", text: "Rapid technological advancement driven by military necessity, transforming aircraft from reconnaissance tools to weapons of war.", imageSrc: getPlaceholderUrl(400,250,'WWI Overview') },
                            { title: "Powered Flight Era", subtitle: "Golden Age (Overview)", text: "A period of public fascination, record-breaking flights, barnstorming, and the beginnings of commercial air travel and mail services.", imageSrc: getPlaceholderUrl(400,250,'Golden Age Overview') },
                            { title: "Powered Flight Era", subtitle: "WWII (Overview)", text: "Mass production, strategic importance of air power, and the emergence of jet propulsion technology near the war's end.", imageSrc: getPlaceholderUrl(400,250,'WWII Overview') }
                        ],
                        segmentDetails: [
                            [
                                { title: "Wright Brothers", subtitle: "1903 CE", text: "Orville and Wilbur Wright achieved...", imageSrc: getPlaceholderUrl(400, 250, 'Wright Flyer') },
                                { title: "Louis Blériot", subtitle: "1909 CE", text: "Blériot made the first flight...", imageSrc: getPlaceholderUrl(400, 250, 'Bleriot XI') }
                            ],
                            [
                                { title: "Rapid Advancement", subtitle: "Military Needs", text: "WWI dramatically accelerated...", imageSrc: getPlaceholderUrl(400, 250, 'WWI Biplane') },
                                { title: "Ace Pilots", subtitle: "Air Combat", text: "The era saw the rise of 'ace' pilots...", imageSrc: getPlaceholderUrl(400, 250, 'Red Baron') }
                            ],
                            [
                                { title: "Air Mail & Airlines", subtitle: "Commercial Growth", text: "Barnstorming, air races...", imageSrc: getPlaceholderUrl(400, 250, 'Ford Trimotor') },
                                { title: "Lindbergh's Flight", subtitle: "1927 CE", text: "Charles Lindbergh's solo flight...", imageSrc: getPlaceholderUrl(400, 250, 'Spirit of St Louis') },
                                { title: "Amelia Earhart", subtitle: "Record Breaking", text: "Amelia Earhart became...", imageSrc: getPlaceholderUrl(400, 250, 'Amelia Earhart') }
                            ],
                            [
                                { title: "Mass Production", subtitle: "Industrial Scale", text: "WWII saw unprecedented...", imageSrc: getPlaceholderUrl(400, 250, 'B-17 Bomber') },
                                { title: "Jet Engine Emergence", subtitle: "New Propulsion", text: "Germany and Britain developed...", imageSrc: getPlaceholderUrl(400, 250, 'Me 262 Jet') }
                            ]
                        ]
                    },
                    { name: "Connector 2", color: "#3A98B9", isConnector: true, arrowCount: 6, thickness: 7 },
                    {
                        name: "Jet Age & Space", radius: 100, color: "#32CD32", segments: 3,
                        segmentNames: ["Early Jet Age", "Supersonic/Jumbos", "Modern Aviation"],
                         segmentOverviews: [
                            { title: "Jet Age & Space", subtitle: "Early Jet Age (Overview)", text: "Breaking the sound barrier, the introduction of revolutionary jet airliners, and the start of the space race.", imageSrc: getPlaceholderUrl(400,250,'Early Jet Overview') },
                            { title: "Jet Age & Space", subtitle: "Supersonic/Jumbos (Overview)", text: "Marked by the moon landing, the advent of wide-body jets enabling mass travel, and the brief era of supersonic passenger flight.", imageSrc: getPlaceholderUrl(400,250,'Jumbo Overview') },
                            { title: "Jet Age & Space", subtitle: "Modern Aviation (Overview)", text: "Characterized by digital flight controls, advanced materials, satellite navigation, and the rise of unmanned aerial vehicles.", imageSrc: getPlaceholderUrl(400,250,'Modern Overview') }
                        ],
                        segmentDetails: [
                            [
                                { title: "Breaking Sound Barrier", subtitle: "1947 CE", text: "Chuck Yeager, piloting...", imageSrc: getPlaceholderUrl(400, 250, 'Bell X-1') },
                                { title: "Jet Airliners", subtitle: "Comet, 707", text: "The introduction of jet airliners...", imageSrc: getPlaceholderUrl(400, 250, 'Boeing 707') },
                                { title: "Space Race Begins", subtitle: "Sputnik & NASA", text: "The launch of Sputnik...", imageSrc: getPlaceholderUrl(400, 250, 'Sputnik') }
                            ],
                            [
                                { title: "Apollo Moon Landing", subtitle: "1969 CE", text: "The Apollo 11 mission...", imageSrc: getPlaceholderUrl(400, 250, 'Apollo 11') },
                                { title: "Boeing 747 'Jumbo Jet'", subtitle: "1969 CE", text: "The arrival of the wide-body...", imageSrc: getPlaceholderUrl(400, 250, 'Boeing 747') },
                                { title: "Concorde SST", subtitle: "1976 CE", text: "The Concorde offered...", imageSrc: getPlaceholderUrl(400, 250, 'Concorde') }
                            ],
                            [
                                { title: "Fly-by-Wire & Composites", subtitle: "A320, 777/787", text: "Advanced digital flight controls...", imageSrc: getPlaceholderUrl(400, 250, 'Airbus A320 Cockpit') },
                                { title: "GPS Navigation", subtitle: "Satellite Tech", text: "Global Positioning System...", imageSrc: getPlaceholderUrl(400, 250, 'GPS Satellite') },
                                { title: "UAVs / Drones", subtitle: "Unmanned Systems", text: "The development and proliferation...", imageSrc: getPlaceholderUrl(400, 250, 'Drone') }
                            ]
                        ]
                    },
                    { name: "Connector 3", color: "#91B93A", isConnector: true, arrowCount: 5, thickness: 6 },
                    {
                        name: "Future of Flight", radius: 50, color: "#FF7F50", segments: 1,
                        segmentNames: ["Emerging Tech"],
                        segmentOverviews: [ // Only one segment
                             { title: "Future of Flight", subtitle: "Emerging Tech (Overview)", text: "Current and near-future developments focusing on sustainability (electric, hydrogen), new forms of mobility (eVTOLs), high-speed travel (hypersonics), and commercial spaceflight.", imageSrc: getPlaceholderUrl(400,250,'Future Overview') }
                        ],
                        segmentDetails: [
                            [ // Only one segment
                                { title: "Sustainable Aviation", subtitle: "Electric & Hydrogen", text: "Focus on reducing environmental impact...", imageSrc: getPlaceholderUrl(400, 250, 'Electric Plane Concept') },
                                { title: "Urban Air Mobility", subtitle: "eVTOLs", text: "Development of electric VTOL...", imageSrc: getPlaceholderUrl(400, 250, 'eVTOL Concept') },
                                { title: "Hypersonic Travel", subtitle: "Mach 5+", text: "Research into hypersonic flight...", imageSrc: getPlaceholderUrl(400, 250, 'Hypersonic Concept') },
                                { title: "Space Tourism", subtitle: "Commercial Spaceflight", text: "Companies are developing...", imageSrc: getPlaceholderUrl(400, 250, 'Space Tourism Rocket') }
                            ]
                        ]
                    }
                ]
            };
            calculateScaleAndGap();
        }

        // --- Responsive Dimensions & Scaling ---
        function getResponsiveDimensions() {
            const containerWidth = chartContainer.clientWidth;
            const containerHeight = chartContainer.clientHeight;
            const padding = Math.min(containerWidth, containerHeight) * 0.04;
            const size = Math.min(containerWidth - 2 * padding, containerHeight - 2 * padding);
            return { width: containerWidth, height: containerHeight, chartSize: size, centerX: containerWidth / 2, centerY: containerHeight / 2 };
        }

        function calculateScaleAndGap() {
             const baseOuterRadius = config.rings[0].radius;
             scaleFactor = (baseOuterRadius > 0) ? (config.chartSize / 2 / baseOuterRadius) : 1;
             gapSize = Math.max(5, 15 * scaleFactor);
        }

        // --- Chart Creation ---
        function createChart() {
            const dimensions = getResponsiveDimensions();
            config = { ...config, ...dimensions };
            calculateScaleAndGap();

            chartContainer.innerHTML = '';
            svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svgElement.setAttribute("viewBox", `0 0 ${config.width} ${config.height}`);
            svgElement.setAttribute("width", "100%");
            svgElement.setAttribute("height", "100%");
            svgElement.style.backgroundColor = "#ffffff";
            chartContainer.appendChild(svgElement);

            chartGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            svgElement.appendChild(chartGroup);

            // Pre-calculate scaled radii
            config.rings.forEach(ring => {
                if (!ring.isConnector) { ring.scaledRadius = ring.radius * scaleFactor; }
            });

            // Draw rings and arrows
            config.rings.forEach((ring, index) => {
                if (!ring.isConnector) {
                    const outerR = ring.scaledRadius;
                    let nextContentRing = null;
                    for (let j = index + 1; j < config.rings.length; j++) {
                        if (!config.rings[j].isConnector) { nextContentRing = config.rings[j]; break; }
                    }
                    let innerR = nextContentRing ? (nextContentRing.scaledRadius + gapSize) : 0;
                    if (!nextContentRing && ring.segments > 1) { innerR = outerR * 0.1; }
                    innerR = Math.max(0, Math.min(innerR, outerR - 1));
                    createContentRingElements(ring, innerR, outerR, chartGroup); // Pass radii
                } else {
                    const prevContentRing = config.rings[index - 1];
                    let nextContentRing = null;
                    for (let j = index + 1; j < config.rings.length; j++) {
                        if (!config.rings[j].isConnector) { nextContentRing = config.rings[j]; break; }
                    }
                    if (prevContentRing && nextContentRing) {
                        const arrowPlacementRadius = nextContentRing.scaledRadius + (gapSize / 2);
                        createArrowsInGap(ring, arrowPlacementRadius, gapSize, chartGroup);
                    }
                }
            });

            createFloatingLegend();
            applyTransform();
        }

        // --- Create Content Ring Elements (Segments and Dots) ---
        function createContentRingElements(ring, innerRadius, outerRadius, parent) {
            const segmentAngle = 360 / ring.segments;
            const ringIndex = config.rings.indexOf(ring);

            for (let i = 0; i < ring.segments; i++) {
                const startAngle = i * segmentAngle;
                const endAngle = (i + 1) * segmentAngle;

                // --- Draw Segment Path ---
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", describeArc(config.centerX, config.centerY, innerRadius, outerRadius, startAngle, endAngle));
                path.setAttribute("fill", ring.color);
                path.classList.add("segment");
                path.dataset.segmentName = ring.segmentNames[i];
                path.dataset.ringName = ring.name;
                path.dataset.ringIndex = ringIndex;
                path.dataset.segmentIndex = i;

                if (ring.segments > 1) {
                     const brightness = 1 + (i % 2 === 0 ? 0.05 : -0.05);
                     path.style.filter = `brightness(${brightness})`;
                }
                path.addEventListener("pointermove", handleSegmentHover);
                path.addEventListener("pointerleave", hideTooltip);
                // ** RESTORED: Click listener for segment overview **
                path.addEventListener("click", handleSegmentClick);
                parent.appendChild(path);

                // --- Draw Interactive Dots ---
                const details = ring.segmentDetails?.[i] || [];
                const numDots = details.length;
                const angleSpan = endAngle - startAngle;

                details.forEach((detail, detailIndex) => {
                    const dotRadialPos = innerRadius + (outerRadius - innerRadius) / 2;
                    const dotAngularOffset = (angleSpan / (numDots + 1)) * (detailIndex + 1);
                    const dotAngle = startAngle + dotAngularOffset;
                    const pos = polarToCartesian(config.centerX, config.centerY, dotRadialPos, dotAngle);
                    const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    dot.setAttribute("cx", pos.x);
                    dot.setAttribute("cy", pos.y);
                    dot.setAttribute("r", Math.max(3, 5 * scaleFactor));
                    dot.setAttribute("fill", "#ffffff");
                    dot.classList.add("interactive-dot");
                    dot.dataset.ringIndex = ringIndex;
                    dot.dataset.segmentIndex = i;
                    dot.dataset.detailIndex = detailIndex;
                    dot.dataset.title = detail.title;
                    dot.addEventListener("click", handleDotClick); // Listener for dot click
                    dot.addEventListener("pointermove", handleDotHover);
                    dot.addEventListener("pointerleave", hideTooltip);
                    parent.appendChild(dot);
                });

                // --- Add Segment Label ---
                addSegmentLabel(ring, i, innerRadius, outerRadius, startAngle, endAngle, parent);
            }
        }

        // --- Create Arrows In Gap (Unchanged) ---
        function createArrowsInGap(connectorDef, placementRadius, currentGapSize, parent) {
            const arrowCount = connectorDef.arrowCount || 6;
            const arrowColor = connectorDef.color;
            const arrowLength = currentGapSize * 0.7;
            const arrowWidth = currentGapSize * 0.5;
            const connectorGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            connectorGroup.classList.add("connector-group");

            for (let i = 0; i < arrowCount; i++) {
                const angleDeg = (i * 360 / arrowCount);
                const angleRad = (angleDeg - 90) * Math.PI / 180.0;
                const tip = polarToCartesian(config.centerX, config.centerY, placementRadius - arrowLength / 2, angleDeg);
                const baseCenter = polarToCartesian(config.centerX, config.centerY, placementRadius + arrowLength / 2, angleDeg);
                const perpAngleRad = angleRad + Math.PI / 2;
                const wingOffset = arrowWidth / 2;
                const wing1X = baseCenter.x + wingOffset * Math.cos(perpAngleRad);
                const wing1Y = baseCenter.y + wingOffset * Math.sin(perpAngleRad);
                const wing2X = baseCenter.x - wingOffset * Math.cos(perpAngleRad);
                const wing2Y = baseCenter.y - wingOffset * Math.sin(perpAngleRad);
                const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                arrow.setAttribute("points", `${wing1X},${wing1Y} ${wing2X},${wing2Y} ${tip.x},${tip.y}`);
                arrow.setAttribute("fill", arrowColor);
                arrow.classList.add("arrow");
                connectorGroup.appendChild(arrow);
            }
            parent.appendChild(connectorGroup);
        }


        // --- Helper to Describe SVG Arc Path (Unchanged) ---
        function describeArc(x, y, innerRadius, outerRadius, startAngle, endAngle) {
            innerRadius = Math.max(0, innerRadius);
            outerRadius = Math.max(innerRadius + 0.1, outerRadius);
            const startOuter = polarToCartesian(x, y, outerRadius, endAngle);
            const endOuter = polarToCartesian(x, y, outerRadius, startAngle);
            const startInner = polarToCartesian(x, y, innerRadius, endAngle);
            const endInner = polarToCartesian(x, y, innerRadius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            if (Math.abs(endAngle - startAngle) >= 359.99) {
                 const midAngle = startAngle + 180;
                 const midOuter1 = polarToCartesian(x, y, outerRadius, midAngle);
                 const midInner1 = polarToCartesian(x, y, innerRadius, midAngle);
                 const midOuter2 = polarToCartesian(x, y, outerRadius, startAngle);
                 const midInner2 = polarToCartesian(x, y, innerRadius, startAngle);
                 const d = [ "M", startOuter.x, startOuter.y, "A", outerRadius, outerRadius, 0, 0, 0, midOuter1.x, midOuter1.y, "L", midInner1.x, midInner1.y, "A", innerRadius, innerRadius, 0, 0, 1, startInner.x, startInner.y, "Z", "M", midOuter1.x, midOuter1.y, "A", outerRadius, outerRadius, 0, 0, 0, midOuter2.x, midOuter2.y, "L", midInner2.x, midInner2.y, "A", innerRadius, innerRadius, 0, 0, 1, midInner1.x, midInner1.y, "Z" ].join(" ");
                 return d;
            }
            const d = [ "M", startOuter.x, startOuter.y, "A", outerRadius, outerRadius, 0, largeArcFlag, 0, endOuter.x, endOuter.y, "L", endInner.x, endInner.y, "A", innerRadius, innerRadius, 0, largeArcFlag, 1, startInner.x, startInner.y, "Z" ].join(" ");
            return d;
        }

        // --- Helper: Polar to Cartesian Coordinates (Unchanged) ---
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return { x: centerX + (radius * Math.cos(angleInRadians)), y: centerY + (radius * Math.sin(angleInRadians)) };
        }

        // --- Add Segment Label (Unchanged) ---
        function addSegmentLabel(ring, segmentIndex, innerR, outerR, startAng, endAng, parent) {
            const angleSpan = endAng - startAng;
            const radiusSpan = outerR - innerR;
            if (radiusSpan < 20 || angleSpan < 15) return;
            const midAngle = startAng + angleSpan / 2;
            const textRadius = innerR + radiusSpan * 0.6;
            const pos = polarToCartesian(config.centerX, config.centerY, textRadius, midAngle);
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", pos.x); text.setAttribute("y", pos.y);
            text.setAttribute("text-anchor", "middle"); text.setAttribute("dominant-baseline", "middle");
            text.style.fontSize = `${Math.min(14, Math.max(8, radiusSpan / 3.5))}px`;
            text.textContent = ring.segmentNames[segmentIndex];
            let rotation = midAngle; if (rotation > 90 && rotation < 270) { rotation += 180; }
            text.setAttribute("transform", `rotate(${rotation}, ${pos.x}, ${pos.y})`);
            const labelGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            labelGroup.classList.add("label-group");
            const textShadow = text.cloneNode(true); textShadow.classList.add("label-shadow");
            textShadow.style.fill = 'none'; textShadow.style.stroke = 'rgba(0,0,0,0.6)';
            textShadow.style.strokeWidth = '3px'; textShadow.style.strokeLinejoin = 'round';
            labelGroup.appendChild(textShadow); labelGroup.appendChild(text);
            parent.appendChild(labelGroup);
        }

        // --- Legend Creation (Unchanged) ---
        function createFloatingLegend() {
            legendContainer.innerHTML = ''; legendContainer.className = 'legend';
            const dragHandle = document.createElement('div'); dragHandle.className = 'legend-drag-handle'; legendContainer.appendChild(dragHandle);
            const header = document.createElement('div'); header.className = 'legend-header';
            const title = document.createElement('h3'); title.className = 'legend-title'; title.textContent = 'Legend';
            const toggleBtn = document.createElement('button'); toggleBtn.className = 'legend-toggle'; toggleBtn.innerHTML = '&minus;'; toggleBtn.title = 'Minimize/Maximize Legend';
            header.appendChild(title); header.appendChild(toggleBtn); legendContainer.appendChild(header);
            const content = document.createElement('div'); content.className = 'legend-content'; legendContainer.appendChild(content);
            const ringGroups = {};
            config.rings.forEach((ring) => {
                if (ring.isConnector) return;
                if (!ringGroups[ring.name]) { ringGroups[ring.name] = []; }
                const segmentItems = ring.segmentNames || [];
                segmentItems.forEach((name, i) => {
                    const item = document.createElement('div'); item.className = 'legend-item';
                    const colorBox = document.createElement('div'); colorBox.className = 'legend-color'; colorBox.style.backgroundColor = ring.color;
                    if (ring.segments > 1) { const brightness = 1 + (i % 2 === 0 ? 0.05 : -0.05); colorBox.style.filter = `brightness(${brightness})`; }
                    const label = document.createElement('span'); label.textContent = name;
                    item.appendChild(colorBox); item.appendChild(label); ringGroups[ring.name].push(item);
                });
            });
            for (const ringName in ringGroups) {
                const categoryTitle = document.createElement('div'); categoryTitle.className = 'legend-category'; categoryTitle.textContent = ringName; content.appendChild(categoryTitle);
                ringGroups[ringName].forEach(item => { content.appendChild(item); });
            }
            toggleBtn.addEventListener('click', function() { content.classList.toggle('legend-minimized'); this.innerHTML = content.classList.contains('legend-minimized') ? '&plus;' : '&minus;'; if (!content.classList.contains('legend-minimized')) { content.style.maxHeight = 'calc(70vh - 80px)'; } });
            makeDraggable(legendContainer, dragHandle);
        }

        // --- Draggable Element Functionality (Unchanged) ---
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const dragTarget = handle || element;
            dragTarget.onpointerdown = dragPointerDown;
            function dragPointerDown(e) { e = e || window.event; pos3 = e.clientX; pos4 = e.clientY; element.style.cursor = 'grabbing'; document.onpointerup = closeDragElement; document.onpointermove = elementDrag; }
            function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; setElementPosition(element, pos1, pos2); }
            function setElementPosition(elmnt, p1, p2) { const containerRect = document.body.getBoundingClientRect(); const elmntRect = elmnt.getBoundingClientRect(); let newTop = elmnt.offsetTop - p2; let newLeft = elmnt.offsetLeft - p1; newTop = Math.max(0, Math.min(newTop, containerRect.height - elmntRect.height)); newLeft = Math.max(0, Math.min(newLeft, containerRect.width - elmntRect.width)); elmnt.style.top = newTop + "px"; elmnt.style.left = newLeft + "px"; elmnt.style.right = "auto"; elmnt.style.bottom = "auto"; }
            function closeDragElement() { document.onpointerup = null; document.onpointermove = null; element.style.cursor = 'grab'; if (handle) handle.style.cursor = 'move'; }
            element.style.cursor = 'grab'; if (handle) handle.style.cursor = 'move';
        }

        // --- Tooltip Handling (Unchanged) ---
        function showTooltip(event, textContent) {
            tooltip.style.opacity = 1;
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY + 15 + 'px';
            tooltip.textContent = textContent;
        }
        function hideTooltip() { tooltip.style.opacity = 0; }

        // --- Sidebar Display (Modified for Tabs) ---
        function showSidebar(ringIndex, segmentIndex, initialDetailIndex = -1) { // initialDetailIndex: -1 for overview, >=0 for specific detail
            const ring = config.rings[ringIndex];
            const overview = ring?.segmentOverviews?.[segmentIndex];
            const details = ring?.segmentDetails?.[segmentIndex] || [];

            if (!overview && details.length === 0) {
                console.error("No overview or detail data found for sidebar:", ringIndex, segmentIndex);
                return;
            }

            // Use overview title/subtitle as main header, or first detail if no overview
            const mainTitle = overview?.title || details[0]?.title || ring.name;
            const mainSubtitle = overview?.subtitle || details[0]?.subtitle || ring.segmentNames[segmentIndex];

            let contentHTML = `<button class="sidebar-close" id="close-sidebar" aria-label="Close Details">&times;</button>`;
            contentHTML += `<h2 class="sidebar-title">${mainTitle}</h2>`;
            contentHTML += `<h3 class="sidebar-subtitle">${mainSubtitle}</h3>`;

            // --- Build Tabs ---
            let tabsHTML = '<div class="content-tabs">';
            let contentSectionsHTML = '<div class="tab-content">'; // Container for content sections

            // Add Overview Tab (if overview exists)
            if (overview) {
                const overviewActive = (initialDetailIndex === -1); // Active if no specific detail requested
                tabsHTML += `<button class="tab-button ${overviewActive ? 'active' : ''}" data-tab-id="overview">Overview</button>`;
                contentSectionsHTML += `
                    <div class="content-section ${overviewActive ? 'active' : ''}" data-tab-id="overview">
                        ${overview.imageSrc ? `<img class="sidebar-image" src="${overview.imageSrc}" alt="${overview.title || ''}" onerror="handleImageError(this)">` : ''}
                        <p class="sidebar-text">${overview.text || 'No overview available.'}</p>
                    </div>
                `;
            }

            // Add Detail Tabs
            details.forEach((detail, index) => {
                const detailActive = (initialDetailIndex === index); // Active if this detail was requested
                // Use detail.title for tab label, fallback if needed
                const tabLabel = detail.title || `Detail ${index + 1}`;
                tabsHTML += `<button class="tab-button ${detailActive ? 'active' : ''}" data-tab-id="detail-${index}">${tabLabel}</button>`;
                contentSectionsHTML += `
                    <div class="content-section ${detailActive ? 'active' : ''}" data-tab-id="detail-${index}">
                        ${detail.subtitle ? `<h4 class="sidebar-subtitle">${detail.subtitle}</h4>` : ''}
                        ${detail.imageSrc ? `<img class="sidebar-image" src="${detail.imageSrc}" alt="${detail.title || ''}" onerror="handleImageError(this)">` : ''}
                        <p class="sidebar-text">${detail.text || 'No description available.'}</p>
                    </div>
                `;
            });

            tabsHTML += '</div>'; // Close content-tabs
            contentSectionsHTML += '</div>'; // Close tab-content

            // Add tabs and content only if there's more than one item (overview + details > 1)
            if (details.length > 0 && overview) { // Show tabs if overview AND details exist
                 contentHTML += tabsHTML;
            } else if (details.length > 1 && !overview) { // Show tabs if only multiple details exist
                 contentHTML += tabsHTML;
            }
            contentHTML += contentSectionsHTML; // Add content sections regardless

            sidebarContent.innerHTML = contentHTML;
            sidebar.classList.add('active');

            // Add event listeners
            const closeButton = sidebarContent.querySelector('#close-sidebar');
            if (closeButton) { closeButton.addEventListener('click', closeSidebar); }

            // Add tab switching listener using event delegation
            const tabsContainer = sidebarContent.querySelector('.content-tabs');
            if (tabsContainer) {
                tabsContainer.addEventListener('click', handleSidebarTabClick);
            }

            // Add listeners to close sidebar
            setTimeout(() => {
                document.addEventListener('click', closeSidebarOnClickOutside);
                document.addEventListener('keydown', handleEscKey);
            }, 10);
        }

        // --- Sidebar Tab Click Handler ---
        function handleSidebarTabClick(event) {
            if (!event.target.matches('.tab-button')) return; // Only handle clicks on buttons

            const clickedButton = event.target;
            const tabId = clickedButton.dataset.tabId;
            const sidebarContentEl = clickedButton.closest('.sidebar-content');

            // Remove active class from all buttons and sections
            sidebarContentEl.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            sidebarContentEl.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // Add active class to the clicked button and corresponding section
            clickedButton.classList.add('active');
            const activeSection = sidebarContentEl.querySelector(`.content-section[data-tab-id="${tabId}"]`);
            if (activeSection) {
                activeSection.classList.add('active');
            }
        }


        // --- Close Sidebar Functions (Unchanged) ---
        function closeSidebar() {
            sidebar.classList.remove('active');
            document.removeEventListener('click', closeSidebarOnClickOutside);
            document.removeEventListener('keydown', handleEscKey);
        }
        function closeSidebarOnClickOutside(event) {
            if (!sidebar.contains(event.target) && !event.target.closest('.interactive-dot') && !event.target.closest('.segment')) {
                closeSidebar();
            }
        }
        function handleEscKey(event) { if (event.key === "Escape") { closeSidebar(); } }

        // --- Event Handlers Setup ---
        function setupEventListeners() {
            window.addEventListener('resize', handleResize);
            chartContainer.addEventListener('pointerdown', handlePointerDown); // For panning
            chartContainer.addEventListener('wheel', handleWheel, { passive: false });
            // Click/Hover for segments/dots are added during creation
        }
        function handleResize() { createChart(); applyTransform(); }

        // --- Pointer Event Handlers ---
        function handlePointerDown(event) { // For Panning
             if (event.pointerType === 'mouse' && event.button !== 0) return;
             const target = event.target;
             const isInteractive = target.closest('.segment') || target.closest('.interactive-dot') || target.closest('.label-group');
             const isBackground = !isInteractive;
            if (currentZoom > 1 && isBackground) {
                 isPanning = true;
                 lastPointerX = event.clientX;
                 lastPointerY = event.clientY;
                 chartContainer.style.cursor = 'grabbing';
                 chartContainer.setPointerCapture(event.pointerId);
                 document.addEventListener('pointermove', handlePointerMovePan);
                 document.addEventListener('pointerup', handlePointerUp);
                 document.addEventListener('pointercancel', handlePointerUp);
            }
        }
        function handlePointerMovePan(event) { // For panning
            if (!isPanning) return;
            const deltaX = event.clientX - lastPointerX;
            const deltaY = event.clientY - lastPointerY;
            lastPointerX = event.clientX;
            lastPointerY = event.clientY;
            panOffsetX += deltaX;
            panOffsetY += deltaY;
            applyTransform();
        }
         function handlePointerUp(event) { // For panning
            if (isPanning) {
                isPanning = false;
                chartContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default';
                chartContainer.releasePointerCapture(event.pointerId);
                document.removeEventListener('pointermove', handlePointerMovePan);
                document.removeEventListener('pointerup', handlePointerUp);
                document.removeEventListener('pointercancel', handlePointerUp);
            }
        }

        // --- Handlers for Dots and Segments ---
        function handleDotClick(event) {
            // *** Stop propagation crucial to prevent segment click ***
            event.stopPropagation();
            if (isPanning) return;
            const dot = event.target;
            const ringIndex = parseInt(dot.dataset.ringIndex, 10);
            const segmentIndex = parseInt(dot.dataset.segmentIndex, 10);
            const detailIndex = parseInt(dot.dataset.detailIndex, 10);

            if (!isNaN(ringIndex) && !isNaN(segmentIndex) && !isNaN(detailIndex)) {
                // Call showSidebar, passing the detail index to show it initially
                showSidebar(ringIndex, segmentIndex, detailIndex);
            } else {
                 console.error("Missing data indices on clicked dot.");
            }
        }

        function handleSegmentClick(event) {
             if (isPanning) return;
             const segment = event.target;
             const ringIndex = parseInt(segment.dataset.ringIndex, 10);
             const segmentIndex = parseInt(segment.dataset.segmentIndex, 10);

             if (!isNaN(ringIndex) && !isNaN(segmentIndex)) {
                 // Call showSidebar without detail index, defaults to overview
                 showSidebar(ringIndex, segmentIndex);
             } else {
                  console.error("Missing data indices on clicked segment.");
             }
        }


        function handleDotHover(event) {
            const dot = event.target;
            const title = dot.dataset.title || "Details";
            showTooltip(event, title);
        }

        function handleSegmentHover(event) {
            const segment = event.target;
            const segmentName = segment.dataset.segmentName || "";
            const ringName = segment.dataset.ringName || "";
            if (segmentName) { showTooltip(event, `${ringName}: ${segmentName}`); }
        }


        // --- Zoom Handling (Unchanged) ---
        function handleWheel(event) {
            event.preventDefault();
            const zoomDelta = event.deltaY < 0 ? 0.15 : -0.15;
            const rect = svgElement.getBoundingClientRect();
            const pointerX = event.clientX - rect.left;
            const pointerY = event.clientY - rect.top;
            zoomChartAtPoint(zoomDelta, pointerX, pointerY);
        }
        function addZoomControls() {
            const controlsContainer = document.getElementById('zoom-controls');
            controlsContainer.innerHTML = '';
            const zoomInBtn = document.createElement('button');
            zoomInBtn.innerHTML = '+'; zoomInBtn.className = 'zoom-button'; zoomInBtn.ariaLabel = 'Zoom In';
            zoomInBtn.addEventListener('click', () => zoomChart(0.2));
            const zoomOutBtn = document.createElement('button');
            zoomOutBtn.innerHTML = '-'; zoomOutBtn.className = 'zoom-button'; zoomOutBtn.ariaLabel = 'Zoom Out';
            zoomOutBtn.addEventListener('click', () => zoomChart(-0.2));
            const resetBtn = document.createElement('button');
            resetBtn.innerHTML = '&#x21BB;'; resetBtn.className = 'zoom-button'; resetBtn.ariaLabel = 'Reset Zoom';
            resetBtn.addEventListener('click', resetZoomPan);
            controlsContainer.appendChild(zoomInBtn); controlsContainer.appendChild(zoomOutBtn); controlsContainer.appendChild(resetBtn);
        }
        function zoomChart(delta) { // Zooms towards center
            if (!svgElement) return;
            const centerX = config.width / 2; const centerY = config.height / 2;
            zoomChartAtPoint(delta, centerX, centerY);
        }
        function zoomChartAtPoint(zoomDelta, pointX, pointY) {
            const minZoom = 0.2; const maxZoom = 5.0;
            const newZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + zoomDelta * currentZoom));
            if (newZoom === currentZoom) return;
            const oldZoom = currentZoom; currentZoom = newZoom;
            panOffsetX = pointX - (pointX - panOffsetX) * (currentZoom / oldZoom);
            panOffsetY = pointY - (pointY - panOffsetY) * (currentZoom / oldZoom);
            applyTransform(); updateZoomIndicator();
        }
        function resetZoomPan() {
            currentZoom = 1; panOffsetX = 0; panOffsetY = 0;
            applyTransform(); updateZoomIndicator();
        }

        // --- Apply Transformation (Unchanged) ---
        function applyTransform() {
            if (chartGroup) {
                chartGroup.setAttribute('transform', `translate(${panOffsetX}, ${panOffsetY}) scale(${currentZoom})`);
                if (isPanning) { chartContainer.style.cursor = 'grabbing'; }
                else { chartContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default'; }
            } else { console.error("Chart group not found for applying transform."); }
        }

        // --- Update Zoom Indicator (Unchanged) ---
        let indicatorTimeout;
        function updateZoomIndicator() {
            zoomIndicator.textContent = `Zoom: ${Math.round(currentZoom * 100)}%`;
            zoomIndicator.style.opacity = '1';
            clearTimeout(indicatorTimeout);
            indicatorTimeout = setTimeout(() => { zoomIndicator.style.opacity = '0'; }, 1500);
        }

    </script>
</body>
</html>

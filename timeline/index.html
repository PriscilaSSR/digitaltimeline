<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Technology Timeline</title>
    <style>
        /* Basic Reset & Font */
        html, body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f0f4f8;
            touch-action: none; /* Prevent default touch actions like scrolling/zooming on body */
        }

           /* Main Title Styling (Floating) */
    #main-title {
        position: absolute;
        top: 15px;
        left: 15px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 8px 15px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        z-index: 90;
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #343a40;
        cursor: grab; /* Indicate draggable */
        border: 1px solid #dee2e6;
    }

    /* Main container */
    .main-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden; /* Crucial for containing the SVG and sidebar */
        background-color: #ffffff; /* White background for the chart area */
        border-radius: 0px; /* No rounding for the main container */
        box-shadow: none; /* No shadow for the main container */
    }

    /* Chart container */
    #chart-container {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: default; /* Default cursor, changes to grab when zoomed */
        position: relative; /* Needed for absolute positioning of SVG */
        overflow: hidden; /* Clip SVG content */
    }

    /* SVG Styling */
    #chart-container svg {
        display: block; /* Remove extra space below SVG */
        width: 100%;
        height: 100%;
        /* background-color is set in JS now */
    }

    /* Sidebar Styling */
    .sidebar {
        position: absolute;
        top: 0;
        left: -350px; /* Start hidden off-screen */
        height: 100%;
        width: 350px; /* Fixed width */
        max-width: 90%; /* Max width on smaller screens */
        overflow-y: auto; /* Scroll if content overflows */
        background-color: #f8f9fa; /* Light background */
        border-radius: 0 8px 8px 0; /* Rounded corners on the right */
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: left 0.3s ease-in-out; /* Smooth slide animation */
        z-index: 100; /* Above chart, below tooltip */
        border-left: 1px solid #dee2e6; /* Subtle border */
    }
    .sidebar.active { left: 0; } /* Slide in when active */
    .sidebar-content { padding: 25px; position: relative; } /* Add padding */
    .sidebar-close {
        position: absolute; top: 15px; right: 15px; width: 32px; height: 32px;
        background-color: #e9ecef; border-radius: 50%; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
        transition: background-color 0.2s, transform 0.2s; font-weight: bold;
        border: none; font-size: 18px; color: #495057;
    }
    .sidebar-close:hover { background-color: #ced4da; transform: rotate(90deg); }
    .sidebar-image {
        width: 100%; height: auto; max-height: 200px; object-fit: cover;
        margin-bottom: 15px; border-radius: 6px; border: 1px solid #dee2e6;
    }
    /* Sidebar Title/Subtitle now often come from Overview */
    .sidebar-title { font-size: 1.6rem; margin-bottom: 5px; padding-right: 40px; color: #212529; font-weight: 600; } /* Space for close button */
    .sidebar-subtitle { font-size: 1.1rem; margin-bottom: 15px; color: #495057; font-weight: 500; }
    .sidebar-text { line-height: 1.7; margin-bottom: 20px; color: #343a40; font-size: 0.95rem; }

    /* Chart Segment Styling */
    .segment {
        cursor: pointer; /* Clickable again */
        transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out;
        stroke: rgba(0,0,0,0.15); /* Slightly darker segment border */
        stroke-width: 1px; /* Increased stroke width */
        /* Fill color applied dynamically in JS */
    }
    .segment:hover {
        opacity: 0.95; /* Slightly less fade on hover */
        filter: brightness(1.1); /* Brighten significantly on hover */
    }

    /* Interactive Dot Styling */
    .interactive-dot {
        cursor: pointer;
        stroke: rgba(0, 0, 0, 0.3); /* Slightly lighter border for gray dots */
        stroke-width: 1px;
        transition: r 0.2s ease-in-out, filter 0.2s ease-in-out, opacity 0.2s ease-in-out;
        fill-opacity: 0.9; /* Slightly more opaque */
        /* Fill color set in JS */
    }
    .interactive-dot:hover {
        r: 7; /* Increase size */
        stroke-width: 1.5px; /* Thicker border */
        filter: brightness(1.15); /* Adjust brightness for gray */
        fill-opacity: 1; /* Fully opaque */
    }

    /* Tooltip Styling */
    .tooltip {
        position: absolute; padding: 8px 12px; background: rgba(0, 0, 0, 0.8);
        color: white; border-radius: 4px; pointer-events: none; opacity: 0;
        transition: opacity 0.2s ease-in-out; font-size: 0.85rem; z-index: 110; /* Above sidebar */
        white-space: nowrap; /* Prevent wrapping */
    }

    /* Legend Styling */
    .legend {
        position: absolute; display: flex; flex-direction: column; gap: 0px; /* No gap between internal elements */
        background-color: rgba(255, 255, 255, 0.95); border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); padding: 0; max-width: 280px;
        max-height: 70vh; z-index: 90; right: 20px; bottom: 20px; /* Default position */
        transition: opacity 0.3s ease, box-shadow 0.3s ease; border: 1px solid #dee2e6;
    }
    .legend-drag-handle {
        cursor: move; width: 100%; height: 18px; display: flex; justify-content: center;
        align-items: center; background-color: #f1f3f5; border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0; box-sizing: border-box;
    }
    .legend-drag-handle:before { content: ""; width: 40px; height: 5px; background-color: #adb5bd; border-radius: 3px; } /* Drag indicator */
    .legend-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 12px; box-sizing: border-box; border-bottom: 1px solid #e9ecef; }
    .legend-title { font-weight: 600; font-size: 1rem; margin: 0; color: #343a40; }
    .legend-toggle { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #495057; padding: 0 5px; line-height: 1; transition: color 0.2s, transform 0.2s; }
    .legend-toggle:hover { color: #212529; transform: scale(1.1); }
    .legend-content { display: flex; flex-direction: column; gap: 8px; width: 100%; padding: 12px; box-sizing: border-box; max-height: calc(70vh - 80px); /* Adjust based on header/handle height */ overflow-y: auto; transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out; }
    .legend-category { margin-top: 5px; margin-bottom: 3px; font-weight: 600; font-size: 0.9rem; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 3px; }
    .legend-category:first-child { margin-top: 0; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #495057; cursor: pointer; }
    .legend-color { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); /* Background color set dynamically in JS */ }
    .legend-content.legend-minimized { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; border-top: none; /* Hide border when minimized */ }

    /* Sidebar Tab Styling (Re-enabled) */
    .content-tabs {
        display: flex;
        flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        margin-top: 15px; /* Space above tabs */
        margin-bottom: 20px;
        gap: 8px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    .tab-button {
        padding: 8px 15px;
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        border-radius: 20px; /* Pill shape */
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .tab-button.active {
        background-color: #007bff; /* Bootstrap primary blue */
        color: white;
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }
    .tab-button:hover:not(.active) {
        background-color: #ced4da;
        border-color: #adb5bd;
    }
    .content-section {
        display: none; /* Hide inactive content */
    }
    .content-section.active {
        display: block;
        animation: fadeIn 0.4s ease; /* Fade in animation */
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Arrow Styling */
    .arrow { filter: drop-shadow(0px 1px 1.5px rgba(0,0,0,0.2)); transition: transform 0.2s ease-in-out; }
    .connector {} /* Connector class no longer used */
    /* Connector Label Styling */
    .connector-label {
        font-weight: bold;
        fill: #4B5563; /* slate-600 */
        text-anchor: middle;
        dominant-baseline: middle;
        pointer-events: none; /* Don't interfere with clicks/zoom */
        /* Font size set dynamically in JS */
    }

    /* Zoom Controls Styling */
    .zoom-controls { position: absolute; right: 20px; top: 20px; z-index: 50; display: flex; flex-direction: column; gap: 8px; }
    .zoom-button { width: 40px; height: 40px; font-size: 20px; font-weight: bold; border-radius: 50%; border: 1px solid #ced4da; background-color: white; color: #495057; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s; }
    .zoom-button:hover { background-color: #f1f3f5; border-color: #adb5bd; }
    .zoom-button:active { box-shadow: 0 1px 2px rgba(0,0,0,0.1); transform: scale(0.95); }

    /* Zoom Indicator Styling */
    #zoom-indicator { position: absolute; left: 20px; bottom: 20px; padding: 6px 12px; background-color: rgba(0,0,0,0.7); color: white; border-radius: 4px; font-size: 0.9rem; transition: opacity 0.3s ease-in-out; opacity: 0; z-index: 50; pointer-events: none; }

    /* Label Styling */
    .label-group text {
         pointer-events: none;
         font-weight: bold;
         fill: #fff; /* White text */
         /* Font size is set dynamically in JS */
    }
    /* Removed label-shadow class as it's hard to apply reliably to textPath */

</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>
<body>
    <h1 id="main-title">Human Flight Timeline</h1>
   <div class="main-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content" id="sidebar-content">
        </div>
    </div>

    <div id="chart-container">
         <svg width="0" height="0" style="position:absolute;overflow:hidden;">
            <defs id="text-path-defs">
            </defs>
        </svg>
    </div>

    <div class="zoom-controls" id="zoom-controls">
    </div>

    <div id="zoom-indicator">Zoom: 100%</div>
</div>

<div class="legend" id="legend">
</div>

<div class="tooltip" id="tooltip"></div>

<script>
    // --- Configuration ---
    let config = {}; // Will be populated by initializeConfig
    let scaleFactor = 1; // How much to scale base radii
    let gapSize = 15; // Gap between content rings (scaled)

    // --- State Variables ---
    let currentZoom = 1;
    let panOffsetX = 0;
    let panOffsetY = 0;
    let isPanning = false;
    let lastPointerX = 0;
    let lastPointerY = 0;
    // For touch-based panning
    let lastTouchX = 0;
    let lastTouchY = 0;
    let initialPinchDistance = 0; // For pinch-zoom

    // --- DOM Elements ---
    let chartContainer, svgElement, chartGroup, sidebar, sidebarContent, tooltip, legendContainer, zoomIndicator, mainTitleElement, textPathDefs;

    // --- Placeholder Image Handling ---
    const placeholderBase = "https://placehold.co";
    const imageUrlBase = "../img";
    function getPlaceholderUrl(width = 400, height = 250, text = "Image") {
        return `${placeholderBase}/${width}x${height}/EBF0F5/777?text=${encodeURIComponent(text)}`;
    }
    function getImagePath(width = 400, height = 250, text = "Image") {
        return `${imageUrlBase}/${text}.jpg`;
    }
    function handleImageError(imgElement) {
        console.warn(`Image failed to load: ${imgElement.src}. Using placeholder.`);
        imgElement.src = getPlaceholderUrl(300, 180, 'Not Found');
        imgElement.onerror = null;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        chartContainer = document.getElementById('chart-container');
        sidebar = document.getElementById('sidebar');
        sidebarContent = document.getElementById('sidebar-content');
        tooltip = document.getElementById('tooltip');
        legendContainer = document.getElementById('legend');
        zoomIndicator = document.getElementById('zoom-indicator');
        mainTitleElement = document.getElementById('main-title');
        textPathDefs = document.getElementById('text-path-defs');

        initializeConfig();
        createChart();
        addZoomControls();
        setupEventListeners();
        applyTransform();

        if (mainTitleElement) {
            makeDraggable(mainTitleElement);
        }
    });

    // --- Configuration Setup ---
    function initializeConfig() {
        const dimensions = getResponsiveDimensions();
        config = {
            ...dimensions,
            rings: [
                 {
                    name: "Key Literary & Cultural Works", radius: 200, segments: 3,
                    segmentColors: ["#94A3B8", "#64748B", "#475569"],
                    segmentNames: ["500s BCE to 1399s CE", "1400 CE to 1799 CE", "1800 CE to 1945 CE"],
                    segmentOverviews: [
                        { title: "Key Literary & Cultural Works", subtitle: "500s BCE to 1399s CE (Overview)", text: "Early myths, legends, and tales reflecting humanity's ancient fascination with flight and the heavens.", imageSrc: getPlaceholderUrl(400,250,'Early Lit Overview') },
                        { title: "Key Literary & Cultural Works", subtitle: "1400 CE to 1799 CE (Overview)", text: "Renaissance and Enlightenment works exploring celestial travel and imaginative flying devices, often blending science and fantasy.", imageSrc: getPlaceholderUrl(400,250,'Renaissance Lit Overview') },
                        { title: "Key Literary & Cultural Works", subtitle: "1800 CE to 1945 CE (Overview)", text: "The rise of science fiction and early cinema depicting voyages to the moon, aerial warfare, and the growing impact of aviation.", imageSrc: getPlaceholderUrl(400,250,'Modern Lit Overview') }
                    ],
                    segmentDetails: [
                        [
                            { title: "The Myth of Icarus and Daedalus", subtitle: "c. 500s BCE", text: "An ancient Greek myth that captures the human desire to transcend earthly limits. The tragic flight of Icarus has long symbolized both the aspiration for flight and the risks of overreaching, inspiring later generations to explore aerial innovation.", imageSrc: getImagePath(400, 250, 'icarus') },
                            { title: "The Pushpaka Vimana", subtitle: "c. 500s BCE", text: "A mythological flying chariot from Indian lore, the Pushpaka Vimana represents early conceptualizations of aerial vehicles.", imageSrc: getPlaceholderUrl(400, 250, 'Pushpaka Vimana') },
                            { title: "The Ebony Horse Tale", subtitle: "c. 800s CE", text: "This medieval narrative of a mechanical, flying horse illustrates the imaginative leap from myth to the idea of engineered flight.", imageSrc: getPlaceholderUrl(400, 250, 'Ebony Horse') }
                        ],
                        [
                            { title: "Kepler's Somnium", subtitle: "1634", text: "A visionary work that blends astronomy with imaginative flight.", imageSrc: getPlaceholderUrl(400, 250, 'Kepler Somnium') },
                            { title: "Francis Godwin's The Man in the Moone", subtitle: "1638", text: "One of the earliest narratives to describe human space travel, this work combined scientific speculation with imaginative adventure.", imageSrc: getPlaceholderUrl(400, 250, 'Man in Moone') },
                            { title: "Cyrano de Bergerac's Comical History", subtitle: "1657", text: "Using satire to explore the possibilities of aerial adventure, this work reflected early modern debates about science and technology.", imageSrc: getPlaceholderUrl(400, 250, 'Cyrano History') },
                            { title: "Jonathan Swift's Flying Island of Laputa", subtitle: "1726", text: "In this satirical tale, Swift uses the concept of a floating island to critique scientific hubris.", imageSrc: getPlaceholderUrl(400, 250, 'Laputa') }
                        ],
                        [
                            { title: "Jules Verne's Novels", subtitle: "1865-1904", text: "Verne’s adventure stories, filled with visionary ideas like space travel and underwater exploration, ignited public interest.", imageSrc: getPlaceholderUrl(400, 250, 'Jules Verne') },
                            { title: "Georges Méliès's A Trip to the Moon", subtitle: "1902", text: "This groundbreaking film popularized the idea of venturing into space.", imageSrc: getPlaceholderUrl(400, 250, 'Trip to Moon Film') },
                            { title: "H.G. Wells's The War in the Air", subtitle: "1908", text: "Wells’s speculative narrative explored the military and societal implications of aerial warfare.", imageSrc: getPlaceholderUrl(400, 250, 'War in the Air') }
                        ]
                    ]
                },
                { name: "Connector 1", color: "#475569", isConnector: true, arrowCount: 8, thickness: 7 },
                {
                    name: "Socioeconomic Factors", radius: 155, segments: 4,
                    segmentColors: ["#BAE6FD", "#7DD3FC", "#38BDF8", "#0EA5E9"],
                    segmentNames: ["500s BCE to 1399s CE", "1400 CE to 1699s CE", "1760s CE to 1890s CE", "1890s CE to 1980s CE"],
                    segmentOverviews: [
                        { title: "Socioeconomic Factors", subtitle: "500s BCE to 1399s CE (Overview)", text: "Early trade routes and technological exchanges influenced aviation technologies.", imageSrc: getPlaceholderUrl(400,250,'Ancient SocioEco') },
                        { title: "Socioeconomic Factors", subtitle: "1400 CE to 1699s CE (Overview)", text: "The Renaissance spurred innovation through patronage and information dissemination.", imageSrc: getPlaceholderUrl(400,250,'Renaissance SocioEco') },
                        { title: "Socioeconomic Factors", subtitle: "1760s CE to 1890s CE (Overview)", text: "The Industrial Revolution provided new materials and manufacturing capabilities.", imageSrc: getPlaceholderUrl(400,250,'Industrial SocioEco') },
                        { title: "Socioeconomic Factors", subtitle: "1890s CE to 1980s CE (Overview)", text: "World Wars accelerated aviation development and post-war commercial growth.", imageSrc: getPlaceholderUrl(400,250,'Modern SocioEco') }
                    ],
                    segmentDetails: [
                        [
                            { title: "The Silk Road", subtitle: "c. 130s BCE - 1200s CE", text: "A vast network linking Asia, the Middle East, and Europe that enabled cultural and technological exchange.", imageSrc: getPlaceholderUrl(400, 250, 'Silk Trade') },
                            { title: "Paper Production and Trade", subtitle: "c. 100s BCE - 1200s CE", text: "Paper’s lightweight properties were crucial for early documentation and certain flight experiments.", imageSrc: getPlaceholderUrl(400, 250, 'Paper Making') },
                            { title: "Gunpowder Production", subtitle: "c. 900s CE onward", text: "The invention of gunpowder marked humanity's first controlled use of explosive force.", imageSrc: getPlaceholderUrl(400, 250, 'Gunpowder') }
                        ],
                        [
                            { title: "Renaissance Patronage System", subtitle: "c. 1400 CE to 1699 CE", text: "Patronage supported ambitious projects including early flying machine designs.", imageSrc: getPlaceholderUrl(400, 250, 'Patronage') },
                            { title: "Age of Exploration - Sail Making", subtitle: "c. 1400 CE to 1699 CE", text: "Techniques honed in sail-making influenced later glider and balloon coverings.", imageSrc: getPlaceholderUrl(400, 250, 'Sail Making') },
                            { title: "The Printing Press", subtitle: "c. 1430s", text: "Revolutionized communication, aiding the spread of new scientific ideas.", imageSrc: getPlaceholderUrl(400, 250, 'Printing Press') },
                            { title: "The Gentleman Scientist Tradition", subtitle: "c. 1400s to 1600s CE", text: "Amateur scientists helped transition theoretical ideas into systematic experiments.", imageSrc: getPlaceholderUrl(400, 250, 'Gentleman Scientist') }
                        ],
                        [
                            { title: "The Industrial Revolution", subtitle: "Industrial Advancements", text: "Rapid technological change provided the foundation for experimental flying machines.", imageSrc: getPlaceholderUrl(400, 250, 'Industrial Revolution') },
                            { title: "Vulcanization of Rubber", subtitle: "1839", text: "Improved material resilience which later aided aircraft component development.", imageSrc: getPlaceholderUrl(400, 250, 'Rubber') },
                            { title: "Process for Aluminum", subtitle: "1886", text: "Made lightweight, durable aluminum widely available for aircraft construction.", imageSrc: getPlaceholderUrl(400, 250, 'Aluminum') },
                            { title: "Great Exhibitions, World Fairs and Prizes", subtitle: "Early 1900s", text: "Showcased new technologies and spurred rapid advancements through competitions.", imageSrc: getPlaceholderUrl(400, 250, 'Crystal Palace') }
                        ],
                        [
                            { title: "Military Demands in World War I", subtitle: "1914-1918", text: "Wartime research accelerated innovations in aircraft technology.", imageSrc: getPlaceholderUrl(400, 250, 'WWI Investment') },
                            { title: "Post-War Commercial Aviation Infrastructure", subtitle: "Building the Network", text: "Air routes and airports transformed aviation into a commercial enterprise.", imageSrc: getPlaceholderUrl(400, 250, 'Early Airport') },
                            { title: "Military-Industrial Complex (Post-WWII)", subtitle: "Cold War Developments", text: "Collaboration between government and industry fueled rapid aerospace innovations.", imageSrc: getPlaceholderUrl(400, 250, 'Cold War Jets') }
                        ]
                    ]
                },
                { name: "Connector 2", color: "#0EA5E9", isConnector: true, arrowCount: 6, thickness: 7 },
                {
                    name: "Scientific Theories and Breakthroughs", radius: 110, segments: 4,
                    segmentColors: ["#67E8F9", "#22D3EE", "#0DD9FE", "#0891B2"],
                    segmentNames: ["500s BCE to 1599s CE", "1600s CE to 1760s CE", "1770s CE to 1899s CE", "1900s CE to 1945 CE"],
                     segmentOverviews: [
                        { title: "Scientific Theories & Breakthroughs", subtitle: "500s BCE to 1599s CE (Overview)", text: "Early studies of principles like buoyancy and reaction established basic ideas behind flight.", imageSrc: getPlaceholderUrl(400,250,'Ancient Science') },
                        { title: "Scientific Theories & Breakthroughs", subtitle: "1600s CE to 1760s CE (Overview)", text: "The Scientific Revolution introduced fundamental laws and experimental designs.", imageSrc: getPlaceholderUrl(400,250,'Scientific Rev Science') },
                        { title: "Scientific Theories & Breakthroughs", subtitle: "1770s CE to 1899s CE (Overview)", text: "Practical applications and aerodynamic research became central to understanding flight.", imageSrc: getPlaceholderUrl(400,250,'19th Century Science') },
                        { title: "Scientific Theories & Breakthroughs", subtitle: "1900s CE to 1945 CE (Overview)", text: "Modern aerodynamic theories and early jet propulsion concepts took shape.", imageSrc: getPlaceholderUrl(400,250,'Early 20th Science') }
                    ],
                    segmentDetails: [
                        [
                            { title: "Hero's Aeolipile", subtitle: "c. 100s BCE", text: "A steam-powered device demonstrating reaction principles.", imageSrc: getPlaceholderUrl(400, 250, 'Aeolipile') },
                            { title: "Leonardo da Vinci's Bird Anatomy Sketches", subtitle: "Observational Studies", text: "Detailed studies of bird flight and anatomy.", imageSrc: getPlaceholderUrl(400, 250, 'Da Vinci Birds') },
                            { title: "Roger Bacon's Air Support Theory", subtitle: "Early Aerodynamic Ideas", text: "Writings suggesting that air could support a device similar to water supporting a boat.", imageSrc: getPlaceholderUrl(400, 250, 'Roger Bacon') },
                            { title: "Archimedes' Buoyancy Principle", subtitle: "c. 200s BCE", text: "Explains why objects float, fundamental to lighter-than-air flight.", imageSrc: getPlaceholderUrl(400, 250, 'Archimedes') }
                        ],
                        [
                            { title: "Robert Hooke's Airflow", subtitle: "1659", text: "Observations on air resistance and fluid dynamics.", imageSrc: getPlaceholderUrl(400, 250, 'Hooke Airflow') },
                            { title: "Newton's Laws of Motion", subtitle: "1687", text: "Fundamental laws governing force, mass, and acceleration essential for flight.", imageSrc: getPlaceholderUrl(400, 250, 'Newton Laws Motion') },
                            { title: "Bartolomeu de Gusmão's Passarola Design", subtitle: "1709", text: "An early demonstration of a lighter-than-air concept.", imageSrc: getPlaceholderUrl(400, 250, 'Passarola') },
                            { title: "Daniel Bernoulli's Hydrodynamica", subtitle: "1738", text: "Relates fluid speed and pressure, key to understanding lift.", imageSrc: getPlaceholderUrl(400, 250, 'Bernoulli Principle') }
                        ],
                        [
                            { title: "Watt's steam engine work", subtitle: "1760s-1790s", text: "Improvements in steam engine efficiency hint at potential power sources.", imageSrc: getPlaceholderUrl(400, 250, 'Watt Engine') },
                            { title: "Cayley's Glider Design and Fixed-Wing Concept", subtitle: "1799", text: "Separated lift and thrust, designing the modern fixed-wing configuration.", imageSrc: getPlaceholderUrl(400, 250, 'Cayley Glider Design') },
                            { title: "Carnot's cycle", subtitle: "1824", text: "The theoretical basis for heat engine efficiency.", imageSrc: getPlaceholderUrl(400, 250, 'Carnot Cycle') },
                            { title: "Wenham's Wind Tunnel", subtitle: "1871", text: "The first wind tunnel for aerodynamic testing.", imageSrc: getPlaceholderUrl(400, 250, 'Wenham Tunnel') },
                            { title: "Wenham and Browning's systematic testing", subtitle: "Aerodynamic Shape Testing (1871)", text: "Testing different airfoil shapes.", imageSrc: getPlaceholderUrl(400, 250, 'Airfoil Testing') },
                            { title: "Otto's Thermodynamic principles", subtitle: "Engine Efficiency (1876)", text: "Basis for the four-stroke internal combustion engine.", imageSrc: getPlaceholderUrl(400, 250, 'Otto Engine') },
                            { title: "Chanute's improved components", subtitle: "Structural Improvements (1890s)", text: "Innovative glider structures.", imageSrc: getPlaceholderUrl(400, 250, 'Chanute Glider') },
                            { title: "Langley's Aerodrome models", subtitle: "1896", text: "Successful powered model flights.", imageSrc: getPlaceholderUrl(400, 250, 'Langley Aerodrome') },
                            { title: "Pilcher's Powered Aircraft Design", subtitle: "1899", text: "Early attempts at powered flight.", imageSrc: getPlaceholderUrl(400, 250, 'Pilcher Aircraft') }
                        ],
                        [
                            { title: "Prandtl's Boundary-Layer Theory", subtitle: "1904", text: "Understanding airflow near surfaces is crucial for drag reduction.", imageSrc: getPlaceholderUrl(400, 250, 'Prandtl Boundary') },
                            { title: "Kutta & Zhukovsky's Lift Theorem", subtitle: "1906", text: "Mathematical explanation for lift generated by an airfoil.", imageSrc: getPlaceholderUrl(400, 250, 'Lift Theorem') },
                            { title: "Dunne's tailless aircraft designs", subtitle: "Stability Concepts (1908)", text: "Designs focused on inherent aircraft stability.", imageSrc: getPlaceholderUrl(400, 250, 'Dunne Aircraft') },
                            { title: "Coandă's theoretical work", subtitle: "Early Jet Propulsion Ideas (1910)", text: "Early experiments related to jet propulsion effects.", imageSrc: getPlaceholderUrl(400, 250, 'Coanda Effect') }
                        ]
                    ]
                },
                { name: "Connector 3", color: "#0891B2", isConnector: true, arrowCount: 5, thickness: 6 },
                {
                    name: "Practical Implementations", radius: 65, segments: 3,
                    segmentColors: ["#FCD34D", "#F59E0B", "#D97706"],
                    segmentNames: [
                        "Early Concepts & LTA",
                        "Heavier-than-Air Pioneers",
                        "Zappellin & Modern"
                    ],
                     segmentOverviews: [
                         { title: "Practical Implementations", subtitle: "Early Concepts & LTA (Overview)", text: "From unmanned kites and models to early human attempts and breakthrough balloon flight.", imageSrc: getPlaceholderUrl(400,250,'Early LTA Overview') },
                         { title: "Practical Implementations", subtitle: "Heavier-than-Air Pioneers (Overview)", text: "Development of gliders and the experimental path to powered, controlled flights.", imageSrc: getPlaceholderUrl(400,250,'HTA Pioneers Overview') },
                         { title: "Practical Implementations", subtitle: "Zappellin & Modern (Overview)", text: "The rise and fall of rigid airships alongside rapid advances post-World Wars.", imageSrc: getPlaceholderUrl(400,250,'Alt Modern Overview') }
                     ],
                    segmentDetails: [
                        [
                            { title: "Non-Human Flight", subtitle: "Kites, Models, etc.", text: "The history of kites and early models as precursors to flight.", imageSrc: getPlaceholderUrl(400, 250, 'Kites Models') },
                            { title: "Early Attempts at Human Flight", subtitle: "Pre-Ballooning", text: "Legends and documented attempts before successful ballooning.", imageSrc: getPlaceholderUrl(400, 250, 'Tower Jumpers') },
                            { title: "The Age of the Balloon", subtitle: "Lighter-than-Air", text: "The breakthrough of balloon flight by the Montgolfier brothers and others.", imageSrc: getPlaceholderUrl(400, 250, 'Montgolfier Flight') }
                        ],
                        [
                            { title: "Early Glider Experiments", subtitle: "Cayley, Lilienthal, etc.", text: "Key figures in glider design and aerodynamics.", imageSrc: getPlaceholderUrl(400, 250, 'Lilienthal Glider') },
                            { title: "Race Toward Modern Aviation", subtitle: "Wright Brothers, etc.", text: "The systematic approach to achieving powered flight.", imageSrc: getPlaceholderUrl(400, 250, 'Wright Flyer 1903') }
                        ],
                        [
                            { title: "Parallel Alternative: The Zeppelin", subtitle: "Rigid Airships", text: "Count von Zeppelin's development of large dirigibles.", imageSrc: getPlaceholderUrl(400, 250, 'Zeppelin Airship') },
                            { title: "Post-War Advancements", subtitle: "Jet Age & Beyond", text: "Rapid progress in aviation following the first powered flights.", imageSrc: getPlaceholderUrl(400, 250, 'Jet Airliner') }
                        ]
                    ]
                }
            ]
        };
        calculateScaleAndGap();
    }

    // --- Responsive Dimensions & Scaling ---
    function getResponsiveDimensions() {
        const containerWidth = chartContainer.clientWidth;
        const containerHeight = chartContainer.clientHeight;
        const padding = Math.min(containerWidth, containerHeight) * 0.04;
        const size = Math.min(containerWidth - 2 * padding, containerHeight - 2 * padding);
        return { width: containerWidth, height: containerHeight, chartSize: size, centerX: containerWidth / 2, centerY: containerHeight / 2 };
    }

    function calculateScaleAndGap() {
         const baseOuterRadius = config.rings[0]?.radius || 1;
         scaleFactor = (baseOuterRadius > 0) ? (config.chartSize / 2 / baseOuterRadius) : 1;
         gapSize = Math.max(5, 15 * scaleFactor);
    }

    // --- Chart Creation ---
    function createChart() {
        const dimensions = getResponsiveDimensions();
        config = { ...config, ...dimensions };
        calculateScaleAndGap();

        chartContainer.querySelectorAll('svg:not(:first-child)').forEach(el => el.remove());
        const existingSvg = chartContainer.querySelector('svg');
        if (existingSvg) {
            const mainChartGroup = existingSvg.querySelector('#main-chart-group');
            if(mainChartGroup) mainChartGroup.remove();
            const defs = existingSvg.querySelector('#text-path-defs');
            if(defs) defs.innerHTML = '';
            svgElement = existingSvg;
        } else {
             console.error("SVG container not found, cannot create chart.");
             return;
        }

        textPathDefs = svgElement.querySelector('#text-path-defs');
        chartGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        chartGroup.id = 'main-chart-group';
        svgElement.appendChild(chartGroup);

        config.rings.forEach(ring => {
            if (!ring.isConnector) { ring.scaledRadius = ring.radius * scaleFactor; }
        });

        let previousOuterRadius = 0;
        config.rings.forEach((ring, index) => {
            if (!ring.isConnector) {
                const outerR = ring.scaledRadius;
                let nextContentRing = null;
                for (let j = index + 1; j < config.rings.length; j++) {
                    if (!config.rings[j].isConnector) { nextContentRing = config.rings[j]; break; }
                }
                let innerR = nextContentRing ? (nextContentRing.scaledRadius + gapSize) : 0;
                if (!nextContentRing && ring.segments > 1) { innerR = outerR * 0.1; }
                innerR = Math.max(0, Math.min(innerR, outerR - 1));

                createContentRingElements(ring, innerR, outerR, chartGroup);
                previousOuterRadius = outerR;
            } else {
                const prevContentRing = config.rings[index - 1];
                let nextContentRing = null;
                for (let j = index + 1; j < config.rings.length; j++) {
                    if (!config.rings[j].isConnector) { nextContentRing = config.rings[j]; break; }
                }

                if (prevContentRing && nextContentRing) {
                    const placementRadius = nextContentRing.scaledRadius + (gapSize / 2);
                    createConnectorElements(ring, placementRadius, gapSize, chartGroup, nextContentRing.name);
                }
            }
        });

        createFloatingLegend();
        applyTransform();
    }

    // --- Create Content Ring Elements ---
    function createContentRingElements(ring, innerRadius, outerRadius, parent) {
        const segmentAngle = 360 / ring.segments;
        const ringIndex = config.rings.indexOf(ring);

        for (let i = 0; i < ring.segments; i++) {
            const startAngle = i * segmentAngle;
            const endAngle = (i + 1) * segmentAngle;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", describeArc(config.centerX, config.centerY, innerRadius, outerRadius, startAngle, endAngle));
            path.setAttribute("fill", ring.segmentColors?.[i] || ring.color || '#cccccc');
            path.classList.add("segment");
            path.dataset.segmentName = ring.segmentNames[i];
            path.dataset.ringName = ring.name;
            path.dataset.ringIndex = ringIndex;
            path.dataset.segmentIndex = i;
            path.style.filter = '';

            path.addEventListener("pointermove", handleSegmentHover);
            path.addEventListener("pointerleave", hideTooltip);
            path.addEventListener("click", handleSegmentClick);
            parent.appendChild(path);

            const details = ring.segmentDetails?.[i] || [];
            const numDots = details.length;
            const angleSpan = endAngle - startAngle;

            details.forEach((detail, detailIndex) => {
                const dotRadialPos = innerRadius + (outerRadius - innerRadius) / 2;
                const dotAngularOffset = (angleSpan / (numDots + 1)) * (detailIndex + 1);
                const dotAngle = startAngle + dotAngularOffset;
                const pos = polarToCartesian(config.centerX, config.centerY, dotRadialPos, dotAngle);

                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute("cx", pos.x);
                dot.setAttribute("cy", pos.y);
                dot.setAttribute("r", Math.max(3, 5 * scaleFactor));
                dot.setAttribute("fill", "#F1F5F9");
                dot.classList.add("interactive-dot");
                dot.dataset.ringIndex = ringIndex;
                dot.dataset.segmentIndex = i;
                dot.dataset.detailIndex = detailIndex;
                dot.dataset.title = detail.title;
                dot.addEventListener("click", handleDotClick);
                dot.addEventListener("pointermove", handleDotHover);
                dot.addEventListener("pointerleave", hideTooltip);
                parent.appendChild(dot);
            });

            if (ring.name !== "Practical Implementations") {
                addSegmentLabel(ring, i, innerRadius, outerRadius, startAngle, endAngle, parent);
            }
        }
    }

    // --- Create Connector Elements ---
    function createConnectorElements(connectorDef, placementRadius, currentGapSize, parent, targetRingName) {
        const arrowCount = connectorDef.arrowCount || 6;
        const arrowColor = connectorDef.color;
        const arrowLength = Math.max(4, currentGapSize * 0.7);
        const arrowWidth = Math.max(3, currentGapSize * 0.5);
        const connectorGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        connectorGroup.classList.add("connector-group");

        for (let i = 0; i < arrowCount; i++) {
            const angleDeg = (i * 360 / arrowCount);
            const angleRad = (angleDeg - 90) * Math.PI / 180.0;

            const tip = polarToCartesian(config.centerX, config.centerY, placementRadius - arrowLength / 2, angleDeg);
            const baseCenter = polarToCartesian(config.centerX, config.centerY, placementRadius + arrowLength / 2, angleDeg);

            const perpAngleRad = angleRad + Math.PI / 2;
            const wingOffset = arrowWidth / 2;
            const wing1X = baseCenter.x + wingOffset * Math.cos(perpAngleRad);
            const wing1Y = baseCenter.y + wingOffset * Math.sin(perpAngleRad);
            const wing2X = baseCenter.x - wingOffset * Math.cos(perpAngleRad);
            const wing2Y = baseCenter.y - wingOffset * Math.sin(perpAngleRad);

            const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            arrow.setAttribute("points", `${wing1X},${wing1Y} ${wing2X},${wing2Y} ${tip.x},${tip.y}`);
            arrow.setAttribute("fill", arrowColor);
            arrow.classList.add("arrow");
            connectorGroup.appendChild(arrow);
        }

        parent.appendChild(connectorGroup);
    }

    // --- Helper to Describe SVG Arc Path ---
    function describeArc(x, y, innerRadius, outerRadius, startAngle, endAngle) {
        innerRadius = Math.max(0, innerRadius);
        outerRadius = Math.max(innerRadius + 0.1, outerRadius);

        const startOuter = polarToCartesian(x, y, outerRadius, endAngle);
        const endOuter = polarToCartesian(x, y, outerRadius, startAngle);
        const startInner = polarToCartesian(x, y, innerRadius, endAngle);
        const endInner = polarToCartesian(x, y, innerRadius, startAngle);

        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

        if (Math.abs(endAngle - startAngle) >= 359.99) {
             const midAngle = startAngle + 180;
             const midOuter1 = polarToCartesian(x, y, outerRadius, midAngle);
             const midInner1 = polarToCartesian(x, y, innerRadius, midAngle);
             const midOuter2 = polarToCartesian(x, y, outerRadius, startAngle);
             const midInner2 = polarToCartesian(x, y, innerRadius, startAngle);

             const d = [
                 "M", startOuter.x, startOuter.y,
                 "A", outerRadius, outerRadius, 0, 0, 0, midOuter1.x, midOuter1.y,
                 "L", midInner1.x, midInner1.y,
                 "A", innerRadius, innerRadius, 0, 0, 1, startInner.x, startInner.y,
                 "Z",
                 "M", midOuter1.x, midOuter1.y,
                 "A", outerRadius, outerRadius, 0, 0, 0, midOuter2.x, midOuter2.y,
                 "L", midInner2.x, midInner2.y,
                 "A", innerRadius, innerRadius, 0, 0, 1, midInner1.x, midInner1.y,
                 "Z"
             ].join(" ");
             return d;
         }

        const d = [
            "M", startOuter.x, startOuter.y,
            "A", outerRadius, outerRadius, 0, largeArcFlag, 0, endOuter.x, endOuter.y,
            "L", endInner.x, endInner.y,
            "A", innerRadius, innerRadius, 0, largeArcFlag, 1, startInner.x, startInner.y,
            "Z"
        ].join(" ");
        return d;
    }

    // --- Helper: Polar to Cartesian Coordinates ---
    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    // --- Helper: Describe SVG Arc Path for textPath ---
    function describeTextArc(x, y, radius, startAngle, endAngle) {
         const adjustedStartAngle = startAngle + 0.001;
         const adjustedEndAngle = endAngle - 0.001;
         const start = polarToCartesian(x, y, radius, adjustedStartAngle);
         const end = polarToCartesian(x, y, radius, adjustedEndAngle);
         const largeArcFlag = (adjustedEndAngle - adjustedStartAngle) <= 180 ? "0" : "1";
         const sweepFlag = 1;
         const d = [
             "M", start.x, start.y,
             "A", radius, radius, 0, largeArcFlag, sweepFlag, end.x, end.y
         ].join(" ");
         return d;
     }

    // --- Add Segment Label ---
    function addSegmentLabel(ring, segmentIndex, innerR, outerR, startAng, endAng, parent) {
        if (ring.name === "Practical Implementations") {
            return;
        }

        const angleSpan = endAng - startAng;
        const radiusSpan = outerR - innerR;
        const ringIndex = config.rings.indexOf(ring);
        if (radiusSpan < 15 || angleSpan < 25) return;
        const textPathRadius = innerR + radiusSpan / 2;
        const pathId = `label-path-${ringIndex}-${segmentIndex}`;
        const textArcPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        textArcPath.setAttribute("id", pathId);
        textArcPath.setAttribute("d", describeTextArc(config.centerX, config.centerY, textPathRadius, startAng, endAng));
        textArcPath.setAttribute("fill", "none");
        textArcPath.setAttribute("stroke", "none");

        if (textPathDefs) {
             textPathDefs.appendChild(textArcPath);
        } else {
             console.warn("Defs element for text paths not found.");
             parent.appendChild(textArcPath);
        }

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.classList.add("label-group");
        text.style.fontSize = `${Math.min(14, Math.max(9, radiusSpan / 4.5))}px`;

        const textPath = document.createElementNS("http://www.w3.org/2000/svg", "textPath");
        textPath.setAttribute("href", `#${pathId}`);
        textPath.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", `#${pathId}`);
        textPath.setAttribute("startOffset", "50%");
        textPath.setAttribute("text-anchor", "middle");
        textPath.textContent = ring.segmentNames[segmentIndex];
        text.appendChild(textPath);
        parent.appendChild(text);
    }

    // --- Legend Creation ---
    function createFloatingLegend() {
        legendContainer.innerHTML = '';
        legendContainer.className = 'legend';

        const dragHandle = document.createElement('div');
        dragHandle.className = 'legend-drag-handle';
        legendContainer.appendChild(dragHandle);

        const header = document.createElement('div');
        header.className = 'legend-header';
        const title = document.createElement('h3');
        title.className = 'legend-title';
        title.textContent = 'Legend';
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'legend-toggle';
        toggleBtn.innerHTML = '&minus;';
        toggleBtn.title = 'Minimize/Maximize Legend';
        header.appendChild(title);
        header.appendChild(toggleBtn);
        legendContainer.appendChild(header);

        const content = document.createElement('div');
        content.className = 'legend-content';
        legendContainer.appendChild(content);

        const ringGroups = {};
        config.rings.forEach((ring, ringIdx) => {
            if (ring.isConnector) return;
            if (!ringGroups[ring.name]) { ringGroups[ring.name] = []; }
            const segmentItems = ring.segmentNames || [];
            segmentItems.forEach((name, segIdx) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.addEventListener('click', () => {
                    showSidebar(ringIdx, segIdx);
                });
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = ring.segmentColors?.[segIdx] || ring.color || '#cccccc';
                colorBox.style.filter = '';
                const label = document.createElement('span');
                label.textContent = name;
                item.appendChild(colorBox);
                item.appendChild(label);
                ringGroups[ring.name].push(item);
            });
        });

        for (const ringName in ringGroups) {
            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'legend-category';
            categoryTitle.textContent = ringName;
            content.appendChild(categoryTitle);
            ringGroups[ringName].forEach(item => { content.appendChild(item); });
        }

        toggleBtn.addEventListener('click', function() {
            content.classList.toggle('legend-minimized');
            this.innerHTML = content.classList.contains('legend-minimized') ? '&plus;' : '&minus;';
            if (!content.classList.contains('legend-minimized')) {
                content.style.maxHeight = 'calc(70vh - 80px)';
            }
        });

        makeDraggable(legendContainer, dragHandle);
    }

    // --- Draggable Element Functionality ---
    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const dragTarget = handle || element;

        dragTarget.addEventListener('pointerdown', dragPointerDown);

        function dragPointerDown(e) {
            e = e || window.event;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.cursor = 'grabbing';
            document.addEventListener('pointerup', closeDragElement);
            document.addEventListener('pointermove', elementDrag);
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            setElementPosition(element, pos1, pos2);
        }

        function setElementPosition(elmnt, p1, p2) {
             const containerRect = document.body.getBoundingClientRect();
             const elmntRect = elmnt.getBoundingClientRect();
             let newTop = elmnt.offsetTop - p2;
             let newLeft = elmnt.offsetLeft - p1;
             newTop = Math.max(0, Math.min(newTop, containerRect.height - elmntRect.height));
             newLeft = Math.max(0, Math.min(newLeft, containerRect.width - elmntRect.width));
             elmnt.style.top = newTop + "px";
             elmnt.style.left = newLeft + "px";
             elmnt.style.right = "auto";
             elmnt.style.bottom = "auto";
        }

        function closeDragElement() {
            document.removeEventListener('pointerup', closeDragElement);
            document.removeEventListener('pointermove', elementDrag);
            element.style.cursor = 'grab';
            if (handle) handle.style.cursor = 'move';
        }

        element.style.cursor = 'grab';
        if (handle) handle.style.cursor = 'move';
    }

    // --- Tooltip Handling ---
    function showTooltip(event, textContent) {
        tooltip.style.opacity = 1;
        tooltip.style.left = event.pageX + 15 + 'px';
        tooltip.style.top = event.pageY + 15 + 'px';
        tooltip.textContent = textContent;
    }
    function hideTooltip() {
        tooltip.style.opacity = 0;
    }

    // --- Sidebar Display ---
    function showSidebar(ringIndex, segmentIndex, initialDetailIndex = -1) {
        const ring = config.rings[ringIndex];
        const overview = ring?.segmentOverviews?.[segmentIndex];
        const details = ring?.segmentDetails?.[segmentIndex] || [];
        if (!overview && details.length === 0) {
            console.error("No overview or detail data found for sidebar:", ringIndex, segmentIndex);
            return;
        }
        const mainTitle = overview?.title || details[0]?.title || ring.name;
        const mainSubtitle = overview?.subtitle || details[0]?.subtitle || ring.segmentNames[segmentIndex];
        let contentHTML = `<button class="sidebar-close" id="close-sidebar" aria-label="Close Details">&times;</button>`;
        contentHTML += `<h2 class="sidebar-title">${mainTitle}</h2>`;
        contentHTML += `<h3 class="sidebar-subtitle">${mainSubtitle}</h3>`;
        let tabsHTML = '<div class="content-tabs">';
        let contentSectionsHTML = '<div class="tab-content">';

        if (overview) {
            const overviewActive = (initialDetailIndex === -1);
            tabsHTML += `<button class="tab-button ${overviewActive ? 'active' : ''}" data-tab-id="overview">Overview</button>`;
            contentSectionsHTML += `
                <div class="content-section ${overviewActive ? 'active' : ''}" data-tab-id="overview">
                    ${overview.imageSrc ? `<img class="sidebar-image" src="${overview.imageSrc}" alt="${overview.title || ''}" onerror="handleImageError(this)">` : ''}
                    <p class="sidebar-text">${overview.text || 'No overview available.'}</p>
                </div>
            `;
        }

        details.forEach((detail, index) => {
            const detailActive = (initialDetailIndex === index);
            const tabLabel = detail.title || `Detail ${index + 1}`;
            tabsHTML += `<button class="tab-button ${detailActive ? 'active' : ''}" data-tab-id="detail-${index}">${tabLabel}</button>`;
            contentSectionsHTML += `
                <div class="content-section ${detailActive ? 'active' : ''}" data-tab-id="detail-${index}">
                    ${detail.subtitle ? `<h4 class="sidebar-subtitle">${detail.subtitle}</h4>` : ''}
                    ${detail.imageSrc ? `<img class="sidebar-image" src="${detail.imageSrc}" alt="${detail.title || ''}" onerror="handleImageError(this)">` : ''}
                    <p class="sidebar-text">${detail.text || 'No description available.'}</p>
                </div>
            `;
        });

        tabsHTML += '</div>';
        contentSectionsHTML += '</div>';

        const totalItems = (overview ? 1 : 0) + details.length;
        if (totalItems > 1) {
            contentHTML += tabsHTML;
        }
        contentHTML += contentSectionsHTML;
        sidebarContent.innerHTML = contentHTML;
        sidebar.classList.add('active');

        const closeButton = sidebarContent.querySelector('#close-sidebar');
        if (closeButton) { closeButton.addEventListener('click', closeSidebar); }

        const tabsContainer = sidebarContent.querySelector('.content-tabs');
        if (tabsContainer) {
            tabsContainer.addEventListener('click', handleSidebarTabClick);
        }

        setTimeout(() => {
            document.addEventListener('click', closeSidebarOnClickOutside, { capture: true });
            document.addEventListener('keydown', handleEscKey);
        }, 10);
    }

    function handleSidebarTabClick(event) {
        if (!event.target.matches('.tab-button')) return;
        const clickedButton = event.target;
        const tabId = clickedButton.dataset.tabId;
        const sidebarContentEl = clickedButton.closest('.sidebar-content');
        sidebarContentEl.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        sidebarContentEl.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        clickedButton.classList.add('active');
        const activeSection = sidebarContentEl.querySelector(`.content-section[data-tab-id="${tabId}"]`);
        if (activeSection) {
            activeSection.classList.add('active');
        }
    }

    function closeSidebar() {
        sidebar.classList.remove('active');
        document.removeEventListener('click', closeSidebarOnClickOutside, { capture: true });
        document.removeEventListener('keydown', handleEscKey);
    }
    function closeSidebarOnClickOutside(event) {
        if (!sidebar.contains(event.target) && !event.target.closest('.interactive-dot') && !event.target.closest('.segment')) {
            closeSidebar();
        }
    }
    function handleEscKey(event) {
        if (event.key === "Escape") {
            closeSidebar();
        }
    }

    // --- Event Handlers Setup ---
    function setupEventListeners() {
        window.addEventListener('resize', handleResize);
        chartContainer.addEventListener('pointerdown', handlePointerDown);
        chartContainer.addEventListener('wheel', handleWheel, { passive: false });
        chartContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        chartContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
        chartContainer.addEventListener('touchend', handleTouchEnd);
    }
    function handleResize() {
        createChart();
        applyTransform();
    }

    // --- Pointer Event Handlers for Panning ---
    function handlePointerDown(event) {
         if (event.pointerType === 'mouse' && event.button !== 0) return;
         const target = event.target;
         // Explicitly grouping conditions with parentheses
         const isInteractive = target.closest('.segment') || target.closest('.interactive-dot') || target.closest('.label-group') || target.closest('.arrow') || target.closest('.connector-label');
         const isBackground = (target.tagName === 'svg') || ((target.tagName === 'path') && !isInteractive);
         if (currentZoom > 1 && isBackground) {
             isPanning = true;
             lastPointerX = event.clientX;
             lastPointerY = event.clientY;
             chartContainer.style.cursor = 'grabbing';
             chartContainer.setPointerCapture(event.pointerId);
             document.addEventListener('pointermove', handlePointerMovePan);
             document.addEventListener('pointerup', handlePointerUp);
             document.addEventListener('pointercancel', handlePointerUp);
         }
    }
    function handlePointerMovePan(event) {
        if (!isPanning) return;
        const deltaX = event.clientX - lastPointerX;
        const deltaY = event.clientY - lastPointerY;
        lastPointerX = event.clientX;
        lastPointerY = event.clientY;
        panOffsetX += deltaX;
        panOffsetY += deltaY;
        applyTransform();
    }
     function handlePointerUp(event) {
        if (isPanning) {
            isPanning = false;
            chartContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default';
            chartContainer.releasePointerCapture(event.pointerId);
            document.removeEventListener('pointermove', handlePointerMovePan);
            document.removeEventListener('pointerup', handlePointerUp);
            document.removeEventListener('pointercancel', handlePointerUp);
        }
    }

    // --- Touch Event Handlers for Pinch and Pan ---
    function handleTouchStart(event) {
        updateActiveTouches(event);
        if (activeTouches.length === 2) {
            initialPinchDistance = getPinchDistance();
            isPanning = false;
        } else if (activeTouches.length === 1 && currentZoom > 1) {
            isPanning = true;
            lastTouchX = activeTouches[0].clientX;
            lastTouchY = activeTouches[0].clientY;
        }
    }

    function handleTouchMove(event) {
        if (event.touches.length >= 1) {
             event.preventDefault();
        }
        updateActiveTouches(event);
        if (activeTouches.length === 2) {
            const currentPinchDistance = getPinchDistance();
            if (initialPinchDistance > 0) {
                const zoomFactor = currentPinchDistance / initialPinchDistance;
                const rect = svgElement.getBoundingClientRect();
                const pinchCenterX = (activeTouches[0].clientX + activeTouches[1].clientX) / 2 - rect.left;
                const pinchCenterY = (activeTouches[0].clientY + activeTouches[1].clientY) / 2 - rect.top;
                const newZoom = Math.max(0.2, Math.min(5.0, currentZoom * zoomFactor));
                const zoomDelta = newZoom / currentZoom;
                panOffsetX = pinchCenterX - (pinchCenterX - panOffsetX) * zoomDelta;
                panOffsetY = pinchCenterY - (pinchCenterY - panOffsetY) * zoomDelta;
                currentZoom = newZoom;
                applyTransform();
                updateZoomIndicator();
                initialPinchDistance = currentPinchDistance;
            }
        } else if (activeTouches.length === 1 && isPanning) {
             const touch = activeTouches[0];
             const deltaX = touch.clientX - lastTouchX;
             const deltaY = touch.clientY - lastTouchY;
             lastTouchX = touch.clientX;
             lastTouchY = touch.clientY;
             panOffsetX += deltaX;
             panOffsetY += deltaY;
             applyTransform();
        }
    }

    function handleTouchEnd(event) {
        updateActiveTouches(event);
        if (activeTouches.length < 2) {
            initialPinchDistance = 0;
        }
        if (activeTouches.length === 0 && isPanning) {
            isPanning = false;
            chartContainer.style.cursor = currentZoom > 1 ? 'grab' : 'default';
        }
    }

    let activeTouches = [];
    function updateActiveTouches(event) {
         activeTouches = [];
         for (let i = 0; i < event.touches.length; i++) {
             activeTouches.push(event.touches[i]);
         }
    }
    function getPinchDistance() {
        if (activeTouches.length < 2) return 0;
        const dx = activeTouches[0].clientX - activeTouches[1].clientX;
        const dy = activeTouches[0].clientY - activeTouches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    // --- Handlers for Dots and Segments ---
    function handleDotClick(event) {
        event.stopPropagation();
        if (isPanning) return;
        const dot = event.target;
        const ringIndex = parseInt(dot.dataset.ringIndex, 10);
        const segmentIndex = parseInt(dot.dataset.segmentIndex, 10);
        const detailIndex = parseInt(dot.dataset.detailIndex, 10);
        if (!isNaN(ringIndex) && !isNaN(segmentIndex) && !isNaN(detailIndex)) {
            showSidebar(ringIndex, segmentIndex, detailIndex);
        } else {
            console.error("Missing data indices on clicked dot.");
        }
    }
    function handleSegmentClick(event) {
        if (isPanning) return;
        if (event.target.closest('.interactive-dot')) {
             return;
        }
        const segment = event.target.closest('.segment');
        if (!segment) return;
        const ringIndex = parseInt(segment.dataset.ringIndex, 10);
        const segmentIndex = parseInt(segment.dataset.segmentIndex, 10);
        if (!isNaN(ringIndex) && !isNaN(segmentIndex)) {
            showSidebar(ringIndex, segmentIndex, -1);
        } else {
              console.error("Missing data indices on clicked segment.");
        }
    }
    function handleDotHover(event) {
        const dot = event.target;
        const title = dot.dataset.title || "Details";
        showTooltip(event, title);
    }
    function handleSegmentHover(event) {
         if (event.target.closest('.interactive-dot')) {
             hideTooltip();
             return;
         }
        const segment = event.target.closest('.segment');
        if (!segment) return;
        const segmentName = segment.dataset.segmentName || "";
        const ringName = segment.dataset.ringName || "";
        if (segmentName) { showTooltip(event, `${ringName}: ${segmentName}`); }
    }

    // --- Zoom Handling ---
    function handleWheel(event) {
        event.preventDefault();
        const zoomDelta = event.deltaY < 0 ? 0.15 : -0.15;
        const rect = svgElement.getBoundingClientRect();
        const pointerX = event.clientX - rect.left;
        const pointerY = event.clientY - rect.top;
        zoomChartAtPoint(zoomDelta, pointerX, pointerY);
    }
    function addZoomControls() {
        const controlsContainer = document.getElementById('zoom-controls');
        controlsContainer.innerHTML = '';
        const zoomInBtn = document.createElement('button');
        zoomInBtn.innerHTML = '+';
        zoomInBtn.className = 'zoom-button';
        zoomInBtn.setAttribute('aria-label', 'Zoom In');
        zoomInBtn.addEventListener('click', () => zoomChart(0.2));
        const zoomOutBtn = document.createElement('button');
        zoomOutBtn.innerHTML = '-';
        zoomOutBtn.className = 'zoom-button';
        zoomOutBtn.setAttribute('aria-label', 'Zoom Out');
        zoomOutBtn.addEventListener('click', () => zoomChart(-0.2));
        const resetBtn = document.createElement('button');
        resetBtn.innerHTML = '&#x21BB;';
        resetBtn.className = 'zoom-button';
        resetBtn.setAttribute('aria-label', 'Reset Zoom');
        resetBtn.addEventListener('click', resetZoomPan);
        controlsContainer.appendChild(zoomInBtn);
        controlsContainer.appendChild(zoomOutBtn);
        controlsContainer.appendChild(resetBtn);
    }
    function zoomChart(delta) {
        if (!svgElement) return;
        const centerX = config.width / 2;
        const centerY = config.height / 2;
        zoomChartAtPoint(delta, centerX, centerY);
    }
    function zoomChartAtPoint(zoomDelta, pointX, pointY) {
        const minZoom = 0.2; const maxZoom = 5.0;
        const newZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + zoomDelta * currentZoom));
        if (newZoom === currentZoom) return;
        const oldZoom = currentZoom;
        currentZoom = newZoom;
        panOffsetX = pointX - (pointX - panOffsetX) * (currentZoom / oldZoom);
        panOffsetY = pointY - (pointY - panOffsetY) * (currentZoom / oldZoom);
        applyTransform();
        updateZoomIndicator();
    }
    function resetZoomPan() {
        currentZoom = 1;
        panOffsetX = 0;
        panOffsetY = 0;
        applyTransform();
        updateZoomIndicator();
    }
    function applyTransform() {
        if (chartGroup) {
            const maxPanX = (config.width * (currentZoom - 1)) / 2;
            const maxPanY = (config.height * (currentZoom - 1)) / 2;
            panOffsetX = Math.max(-maxPanX - config.width/2 * (currentZoom-1) , Math.min(maxPanX + config.width/2 * (currentZoom-1), panOffsetX));
            panOffsetY = Math.max(-maxPanY - config.height/2 * (currentZoom-1), Math.min(maxPanY + config.height/2 * (currentZoom-1), panOffsetY));
            chartGroup.setAttribute('transform', `translate(${panOffsetX}, ${panOffsetY}) scale(${currentZoom})`);
            chartContainer.style.cursor = isPanning ? 'grabbing' : (currentZoom > 1 ? 'grab' : 'default');
        } else {
            console.error("Chart group not found for applying transform.");
        }
    }
    let indicatorTimeout;
    function updateZoomIndicator() {
        zoomIndicator.textContent = `Zoom: ${Math.round(currentZoom * 100)}%`;
        zoomIndicator.style.opacity = '1';
        clearTimeout(indicatorTimeout);
        indicatorTimeout = setTimeout(() => { zoomIndicator.style.opacity = '0'; }, 1500);
    }
</script>
</body>
</html>
